<!DOCTYPE html>
<html lang="zh-CN">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>祁富强 - 壹比零</title>
	<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon">
	<meta name="description" content="描述">
	<meta name="keywords" content="关键词,祁富强,Re01成员,元岛社区管理员,甘肃不大,创造神话,DAO,梗">
	<meta name="copyright" content="祁富强">
	<meta name="author" content="祁富强">
	<meta property="og:image" content="../../images/logo.png">
	<meta name="og:title" content="祁富强">
	<meta name="og:url" content="http://apicloud.fun">
	<meta name="og:description" content="">
	<meta name="apple-mobile-web-app-title" content="祁富强">

	<!-- Markdown 解析库 -->
	<script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.1/dist/purify.min.js"></script>

	<style>
		:root {
			--icon-size: 50px;
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		marquee span {
			color: #16A085;
		}

		marquee {
			width: 300px;
		}

		::-webkit-scrollbar {
			display: none;
		}

		body {
			color: #FFFFFF;
			font-size: 18px;
			background: #34495E;
			display: flex;
			align-items: center;
			flex-direction: column;
			min-height: 100vh;
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
		}

		header,
		footer {
			width: 100%;
			padding: 40px 0;
			background: #2F4254;
			text-align: center;
		}

		header button {
			background: none;
		}

		header div:nth-of-type(2) {
			display: flex;
			flex-direction: row;
			flex-wrap: nowrap;
			justify-content: center;
			align-items: center;
		}

		header div:nth-of-type(2) button:nth-of-type(1) {
			margin-right: 10px;
		}

		header div:nth-of-type(2) button:nth-of-type(2) {
			margin-left: 10px;
			border-color: #16A085;
		}

		footer {
			font-size: 14px;
			margin-top: 50px;
		}

		a {
			color: #FFFFFF;
			text-decoration: none;
		}

		a:hover {
			text-decoration: underline;
		}

		button {
			color: #FFFFFF;
			background: none;
			border-radius: 10px;
			width: 120px;
			height: 40px;
			position: relative;
			z-index: 8;
			border: 2px solid #16A085;
			cursor: pointer;
			transition: all 0.3s ease;
			box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
			font-weight: bold;
		}

		button:hover {
			transform: translateY(-2px);
			background: rgba(22, 160, 133, 0.8);
			box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
		}

		button:active {
			transform: translateY(0);
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
		}

		article {
			margin: 50px;
			max-width: 1200px;
			text-align: justify;
			width: 100%;
		}

		article>h3 {
			width: 20%;
			transition: all .3s;
			margin-bottom: 30px;
			border-bottom: 3px solid #DDD;
			color: #16A085;
			font-size: 24px;
		}

		article>h3:hover {
			width: 100%;
			border-bottom: 3px dashed rgb(119, 82, 250);
		}

		article .content div {
			text-indent: 2em;
			margin-bottom: 15px;
			line-height: 1.6;
		}

		article .content pre {
			white-space: pre-wrap;
			padding: 1em;
		}

		details {
			text-align: center;
			margin: 20px 0;
		}

		details :not(video) {
			text-align: left;
		}

		/* Changelog编辑按钮悬停样式 */
		.changelog-item-with-edit {
			position: relative;
			transition: background-color 0.3s ease, transform 0.3s ease;
		}

		/* 悬停时添加背景样式 */
		.changelog-item-with-edit:hover {
			background-color: rgba(22, 160, 133, 0.1);
			transform: translateY(-2px);
		}

		.changelog-edit-button {
			opacity: 0;
			transition: opacity 0.3s ease;
		}

		.changelog-item-with-edit button {
			width: auto;
			height: auto;
		}

		/* 悬停时显示编辑/删除按钮 */
		.changelog-item-with-edit:hover .changelog-edit-button {
			color: #000;
			opacity: 1;
			transition: all cubic-bezier(0.075, 0.82, 0.165, 1) 0.3s;
			transform: translateY(-50%);
		}

		.changelog-item-with-edit:hover .changelog-edit-button:hover {
			transform: translateY(-55%) scale(1.1);
		}

		/* 编辑按钮悬停效果 */
		.changelog-edit-button:hover {
			background-color: #16A085;
			transform: scale(1.05);
		}

		/* 时间显示样式 */
		.Ttime:not(:empty),
		.itemTime:not(:empty) {
			display: inline-block;
			min-width: 171px;
			border-radius: 4px;
			font-size: 0.9em;
		}

		/* 删除重复的样式规则 */
		.changelog-edit-button {
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
		}

		/* 子条目样式 - 悬停效果 */
		.changelog-item-with-edit {
			position: relative;
			transition: background-color 0.3s ease, transform 0.3s ease;
			display: grid;
			grid-template-columns: 171px 1fr;
			column-gap: 10px;
			align-items: start;
		}

		.changelog-item-with-edit:hover {
			background-color: rgba(22, 160, 133, 0.1);
		}

		/* 编辑和删除按钮样式 */
		.changelog-edit-button {
			opacity: 0;
			position: absolute;
			right: 5px;
			top: 50%;
			transform: translateY(-50%);
			transition: opacity 0.3s ease, background-color 0.3s ease;
			padding: 4px 8px;
			border: none;
			border-radius: 4px;
			cursor: pointer;
		}

		.changelog-edit-button.delete {
			right: 80px;
		}

		/* 让换行文本与首行对齐（时间在第一列，内容在第二列） */
		.changelog-item-with-edit>.Ttime {
			grid-column: 1;
			position: sticky;
			top: 3rem;
		}

		.changelog-item-with-edit>span {
			grid-column: 2;
			white-space: pre-wrap;
		}

		/* 内容解析样式 */
		.parsed-content {
			line-height: 1.6;
		}

		.parsed-content h1,
		.parsed-content h2,
		.parsed-content h3,
		.parsed-content h4,
		.parsed-content h5,
		.parsed-content h6 {
			margin: 10px 0 5px 0;
			color: #16A085;
			font-weight: 600;
		}

		.parsed-content h1 {
			font-size: 1.4em;
		}

		.parsed-content h2 {
			font-size: 1.3em;
		}

		.parsed-content h3 {
			font-size: 1.2em;
		}

		.parsed-content h4 {
			font-size: 1.1em;
		}

		.parsed-content h5 {
			font-size: 1.0em;
		}

		.parsed-content h6 {
			font-size: 0.9em;
		}

		.parsed-content p {
			margin: 8px 0;
		}

		.parsed-content ul,
		.parsed-content ol {
			margin: 8px 0;
			padding-left: 20px;
		}

		.parsed-content li {
			margin: 4px 0;
		}

		.parsed-content blockquote {
			border-left: 4px solid #16A085;
			margin: 10px 0;
			padding: 10px 15px;
			background-color: rgba(22, 160, 133, 0.1);
			border-radius: 0 4px 4px 0;
		}

		.parsed-content code {
			background-color: rgba(255, 255, 255, 0.1);
			padding: 2px 6px;
			border-radius: 3px;
			font-family: 'Courier New', monospace;
			font-size: 0.9em;
		}

		.parsed-content pre {
			background-color: rgba(0, 0, 0, 0.2);
			padding: 10px;
			border-radius: 4px;
			overflow-x: auto;
			margin: 10px 0;
		}

		.parsed-content pre code {
			background: none;
			padding: 0;
		}

		.parsed-content a {
			color: #16A085;
			text-decoration: underline;
		}

		.parsed-content a:hover {
			color: #1abc9c;
		}

		.parsed-content strong {
			font-weight: 600;
			color: #16A085;
		}

		.parsed-content em {
			font-style: italic;
		}

		.parsed-content img {
			max-width: 100%;
			height: auto;
			border-radius: 4px;
			margin: 10px 0;
		}

		.parsed-content table {
			border-collapse: collapse;
			width: 100%;
			margin: 10px 0;
		}

		.parsed-content th,
		.parsed-content td {
			border: 1px solid rgba(255, 255, 255, 0.2);
			padding: 8px;
			text-align: left;
		}

		.parsed-content th {
			background-color: rgba(22, 160, 133, 0.2);
			font-weight: 600;
		}

		/* 内容类型指示器 */
		.content-type-indicator {
			font-size: 0.7em;
			color: #95a5a6;
			margin-left: 5px;
			font-style: italic;
		}

		.changelog-edit-:hover {
			background-color: #16A085;
			color: white;
		}

		/* 时间轴样式 - 恢复到之前的设计 */
		.timeline {
			max-width: 1200px;
			margin: 0 auto;
			padding: 20px;
			scroll-behavior: smooth;
			/* 自定义滚动条 */
			scrollbar-width: thin;
			scrollbar-color: #16A085 #34495E;
		}

		/* Webkit浏览器的滚动条样式 */
		.timeline::-webkit-scrollbar {
			width: 8px;
		}

		.timeline::-webkit-scrollbar-track {
			background: #34495E;
			border-radius: 4px;
		}

		.timeline::-webkit-scrollbar-thumb {
			background: #16A085;
			border-radius: 4px;
		}

		.timeline::-webkit-scrollbar-thumb:hover {
			background: #138D75;
		}



		/* 滚动指示器 */
		.scroll-indicator {
			position: fixed;
			right: 20px;
			bottom: 20px;
			background: #16A085;
			color: white;
			width: 50px;
			height: 50px;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			opacity: 0;
			transition: opacity 0.3s ease;
			z-index: 1000;
			box-shadow: 0 4px 15px rgba(22, 160, 133, 0.3);
		}

		.scroll-indicator.visible {
			opacity: 1;
		}

		.scroll-indicator:hover {
			background: #138D75;
			transform: scale(1.1);
		}

		.timeline .item {
			position: relative;
			margin-top: 50px;
			display: flex;
			flex-wrap: nowrap;
		}

		.timeline .item:first-of-type {
			margin-top: 0;
		}

		.timeline .item .left {
			margin-right: var(--icon-size);
		}

		.timeline .item .left .icon {
			font-size: var(--icon-size);
			color: #16A085;
			position: sticky;
			top: 0;
			background: #34495E;
		}

		/* 连接线 - 从图标中心到下一个图标中心 */
		.timeline .item:not(:last-of-type) .left::after {
			content: '';
			display: block;
			width: 0px;
			height: calc(100% - 4rem);
			border: 1px dashed;
			margin: auto;
			margin-top: 1rem;
		}

		.timeline .item .right {
			width: 100%;
			text-align: justify;
			background: white;
			border-radius: 12px;
		}

		.timeline .item .right h4 {
			display: flex;
			flex-wrap: nowrap;
			flex-direction: row;
			align-items: center;
			justify-content: space-between;
			padding: 10px;
			border-bottom-left-radius: 10px;
			border-bottom-right-radius: 10px;
			background: rebeccapurple;
			position: sticky;
			top: 0;
			z-index: 10;
		}

		.timeline .item .right h4 span {
			margin-left: 2em;
		}

		.timeline .item .right .content {
			margin: 10px;
			color: #000;
		}

		.timeline .item .right .content p {
			margin: 10px;
		}

		.timeline .item .right .content ol {
			margin: 10px;
			padding-left: 20px;
		}

		.timeline .item .right .content ol li {
			margin: 5px 0;
			line-height: 1.6;
		}

		.timeline .item .right .images {
			margin: 10px;
			display: flex;
			flex-wrap: wrap;
			gap: 10px;
		}

		.timeline .item .right .images img {
			max-width: 90vmin;
			max-height: 88vmin;
			width: auto;
			height: auto;
			border-radius: 8px;
			border: 2px solid #ddd;
		}

		.timeline .item .right .videos {
			display: flex;
			flex-wrap: wrap;
			gap: 10px;
		}

		.timeline .item .right .content video {
			width: 100vmin;
			height: 98vmin;
			border-radius: 5px;
		}

		.Ttime {
			color: #16A085;
		}

		/* 操作按钮样式 */
		.timeline-actions {
			margin: 20px;
			display: flex;
			gap: 10px;
			justify-content: flex-end;
		}

		.timeline-actions {
			background: rgba(52, 152, 219, 0.8);
			border: none;
			padding: 5px 10px;
			border-radius: 5px;
			cursor: pointer;
			font-size: 12px;
			width: auto;
			height: auto;
		}

		.timeline-actions :last-child {
			background: rgba(231, 76, 60, 0.8);
		}

		/* 响应式设计 */
		@media (max-width: 768px) {
			article {
				margin: 20px;
			}

			.timeline {
				padding: 10px;
			}

			.timeline::before {
				left: 30px;
			}

			.timeline .item {
				flex-direction: column;
				align-items: center;
				text-align: center;
			}

			.timeline .left {
				margin-right: 0;
				margin-bottom: 15px;
				width: 60px;
				height: 60px;
				font-size: 20px;
			}

			.timeline .right h4 {
				flex-direction: column;
				gap: 10px;
			}

			.timeline .images {
				grid-template-columns: 1fr;
			}

			.timeline .videos {
				grid-template-columns: 1fr;
			}
		}


		/* 修复按钮样式冲突 */
		.timeline button:not(.timeline-actions button),
		.add-timeline-form button,
		.edit-timeline-form button {
			width: auto !important;
			height: auto !important;
			border: none !important;
			background: none !important;
			backdrop-filter: blur(10px);
		}

		/* 确保表单元素正确显示 */
		.add-timeline-form input,
		.add-timeline-form textarea,
		.add-timeline-form select,
		.edit-timeline-form input,
		.edit-timeline-form textarea,
		.edit-timeline-form select {
			width: 100% !important;
			padding: 10px !important;
			border: 1px solid rgba(255, 255, 255, 0.3) !important;
			border-radius: 5px !important;
			background: rgba(255, 255, 255, 0.1) !important;
			color: white !important;
			font-size: 14px !important;
			margin-bottom: 15px !important;
		}

		/* 确保操作按钮正确显示 */
		.timeline-actions {
			background: rgba(52, 152, 219, 0.8) !important;
			border: none !important;
			padding: 5px 10px !important;
			border-radius: 5px !important;
			cursor: pointer !important;
			font-size: 12px !important;
			width: auto !important;
			height: auto !important;
		}

		.timeline-actions :last-child {
			background: rgba(231, 76, 60, 0.8) !important;
		}

		/* 模态框样式 */
		.modal-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.9);
			display: flex;
			align-items: center;
			justify-content: center;
			z-index: 1000;
			cursor: pointer;
		}

		.modal-image {
			max-width: 90%;
			max-height: 90%;
			object-fit: contain;
		}

		/* 私有标识样式 */
		.private-badge {
			position: absolute;
			top: -10px;
			right: 20px;
			background: #e74c3c;
			color: white;
			padding: 4px 8px;
			border-radius: 12px;
			font-size: 12px;
			z-index: 10;
		}

		/* 防止长文本溢出 */
		.changelog-item-with-edit > span{display:block;white-space:pre-wrap;overflow-wrap:anywhere;word-break:break-word;max-width:100%}
		.right,.right .content{min-width:0}
		.timeline-empty{opacity:.75;padding:8px 0;color:#9aa3ab}
	</style>
</head>

<body>
	<header>
		<a href="../../index.html">
			<img src="../../images/logo.png" alt="" style="border-radius: 50%; width: 360px; height: 360px; object-fit: cover;">
		</a>
		<div>
			<h3>关于</h3>
			<marquee behavior="summary" direction="1000">
				壹比零 <span>&lt;/&gt;</span>
				&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;
				点头像进入首页 <span>&lt;/&gt;</span>
				&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;
				欢迎━(*｀∀´*)ノ亻! <span>&lt;/&gt;</span>
			</marquee>
		</div>
		<div>
			<button>
				<a href="./personalResume.html">(oﾟ▽ﾟ)o我的简介</a>
			</button>
			<button>
				<a href="https://qaiji.gitee.io/yuandao-learning/#/">☈ 留言</a>
			</button>
		</div>
	</header>
	<article>
		<h3>. 是匿蝶吖 .</h3>
		<div class="content">
			<div>在座的各位同志，大家好，我是<strong>壹比零</strong>的作者：祁富强，生于2004年5月15日。号来自甘肃(不大，创造神话)。</div>
			<div>根据我的专业得知这个销售很重要、营销更重要，所以我要营销自己，哎就是玩儿，非常的nice好吧。</div>
			<div>
				<div>不开玩笑了，作为元DAO管理员，正经的宣布一件事</div>
				<details>
					<summary>点击展开</summary>
					<div>
						我个人认为这个意大利面就应该拌42号混凝土，因为这个螺丝钉的长度，它很容易会直接影响到挖掘机的扭矩，你知道吧?你往里砸的时候，一瞬间它就会产生大量的高能蛋白，俗称UFO，
						会严重影响经济的发展，甚至对这个太平洋以及充电器都会造成一定的核污染
					</div>
					<video src="./mp4/卧龙凤雏.mp4" height="600vh" controls preload="metadata"></video><!-- metadata仅加载元数据 -->
					<div>看完视频，大家应该懂什么叫爱情了吧(*^▽^*)</div>
				</details>
			</div>
			<div>其实你可能觉得这并没有什么，但没关系，因为你的感觉是对的。毕竟人每呼吸六十秒，生命就会减少一分钟，你在这待了5分钟，就笑了4分钟，还有一分钟为你浪费了5分钟而叹息。然后接着度过下一个五分钟</div>
			<div>那根据大家都知道每个人身上都有毛毛，让我为你唱年轻人不讲武德，耗子尾汁，得知奇怪的知识增加了，我只希望看到这里你不要给我提意见，不然我会以为 你在教我做事？</div>
			<!-- <div>其实我并不喜欢那种什么体质内啊，洗脑啊什么的，因为每个人都要有自己的生活方式，外国人自由也挺好的，但应该结合，或者说可以替换。平民就由机器人去供养，增加思想上的知识，而不是一味的只知道进厂洗脑，挺可悲的。说起来就是没有给到正反馈，他们的行为就是以恶制恶，陷入恶性循环。</div> -->
			<!-- <div>历年梗</div> -->
		</div>
		<br />
		<br />
		<!-- 时间轴 -->
		<h3 id="MyPast">. My past .</h3>
		<div style="text-align: right; margin-bottom: 10px;">
			<button id="addMyPastBtn" style="display: none; background: #16A085; color: white; border: none; box-sizing: content-box; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
				➕ 添加新项目
			</button>
			<button onclick="checkTokenContent()" style="background: #3498db; color: white; border: none; box-sizing: content-box; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin-left: 10px;">
				🔍 检查用户信息
			</button>
			<button onclick="clearAllCache()" style="background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin-left: 10px;">
				🗑️ 清除缓存
			</button>
		</div>
		<div class="timeline" id="myPastContainer">
			<!-- 动态渲染内容 -->
		</div>
		<!-- 汉子调经 - E6KB -->
		<h3 id="汉子调经">. 调经 .</h3>
		<div style="text-align: right; margin-bottom: 10px;">
			<button id="addHealthBtn" style="display: none; background: #16A085; color: white; border: none; box-sizing: content-box; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
				➕ 添加新项目
			</button>
		</div>
		<div class="timeline" id="healthContainer">
			<!-- 动态渲染内容 -->
		</div>
		<!-- 历史更新 -->
		<h3 id="更新日志">. 更新日志 .</h3>
		<div style="text-align: right; margin-bottom: 10px;">
			<button id="addChangelogBtn" style="display: none; background: #16A085; color: white; border: none; box-sizing: content-box; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
				➕ 添加新版本
			</button>
		</div>
		<div class="timeline" id="versionLogContainer">
			<div style="text-align: center; padding: 20px;">
				<i class="fas fa-spinner fa-spin"></i> 正在加载版本信息...
			</div>
		</div>
		<script>
			// 配置API基础URL
			// 配置API基础URL
			window.OneLoveConfig = { apiBaseUrl: '/api' };
			console.log('API基础URL:', window.OneLoveConfig.apiBaseUrl);

			/**
			 * 从API获取changelog数据
			 */
			async function loadChangelogFromAPI() {
				try {
					const apiBaseUrl = window.OneLoveConfig?.apiBaseUrl || '/api';
					const response = await fetch(`${apiBaseUrl}/changelog?limit=100`);
					const result = await response.json();

					if (result.success && result.data.changelogs) {
						const versionLogs = result.data.changelogs;
						return versionLogs; // 只返回数据，不渲染
					} else {
						throw new Error('获取版本信息失败');
					}
				} catch (error) {
					console.error('加载changelog失败:', error);
					document.getElementById('versionLogContainer').innerHTML =
						'<div style="text-align: center; padding: 20px; color: #ff6b6b;">' +
						'<i class="fas fa-exclamation-triangle"></i> 加载版本信息失败，请稍后重试' +
						'</div>';
					throw error; // 重新抛出错误
				}
			}

			/**
			 * 从API获取最大的order值
			 */
			async function getMaxOrderValue() {
				try {
					const apiBaseUrl = window.OneLoveConfig?.apiBaseUrl || '/api';
					const response = await fetch(`${apiBaseUrl}/changelog?limit=100`);
					const result = await response.json();

					if (result.success && result.data.changelogs) {
						const changelogs = result.data.changelogs;
						let maxOrder = 0;

						changelogs.forEach(item => {
							if (typeof item.order === 'number' && item.order > maxOrder) {
								maxOrder = item.order;
							}
						});

						return maxOrder;
					}
					return 0;
				} catch (error) {
					console.error('获取最大order值失败:', error);
					return 0;
				}
			}

			/**
			 * 从API获取timeline数据
			 */
			async function loadTimelineData(type) {
				try {
					const apiBaseUrl = window.OneLoveConfig?.apiBaseUrl || '/api';
					const timestamp = new Date().getTime();
					let url = `${apiBaseUrl}/timeline-data/${type}?timestamp=${timestamp}`;

					const isDev = await isDeveloper();
					if (isDev) {
						url += '&allUsers=true';
						console.log(`[${new Date().toISOString()}] 开发者用户，获取所有用户的${type}数据`);
					}

					console.log(`[${new Date().toISOString()}] 正在加载${type}数据，API地址: ${url}`);
					const token = localStorage.getItem('token') || sessionStorage.getItem('token');
					console.log(`[${new Date().toISOString()}] 获取到的token:`, token ? `存在 (${token.length}字符)` : '不存在');

					let currentUserId = null;
					try {
						if (token) {
							const base64Url = token.split('.')[1];
							const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
							const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
							const userInfo = JSON.parse(jsonPayload);
							currentUserId = userInfo.userId || userInfo.id || null;
							console.log(`[${new Date().toISOString()}] 当前用户ID:`, currentUserId);
						}
					} catch (e) {
						console.error(`[${new Date().toISOString()}] 解析token失败:`, e);
					}

					const headers = { 'Authorization': token ? `Bearer ${token}` : '' };
					const response = await fetch(url, { headers });
					const result = await response.json();

					if (result.success) {
						const payload = result.data;
						if (isDev && Array.isArray(payload) && payload.length && typeof payload[0] === 'object' && 'userId' in payload[0] && 'data' in payload[0]) {
							const mine = currentUserId ? payload.find(x => x.userId === currentUserId) : null;
							if (mine && Array.isArray(mine.data) && mine.data.length) {
								return { items: mine.data, statusText: '' };
							}
							const merged = [];
							payload.forEach(block => {
								const list = Array.isArray(block.data) ? block.data : [];
								list.forEach(item => {
									const cloned = { ...item };
									if (cloned && typeof cloned === 'object') {
										cloned.title = (cloned.title ? `[${block.userId}] ` + cloned.title : `[${block.userId}]`);
									}
									merged.push(cloned);
								});
							});
							const text = merged.length ? '显示汇总数据（未找到本人数据）' : '暂无数据（未找到任何用户数据）';
							return { items: merged, statusText: text };
						}

						const list = Array.isArray(payload) ? payload : [];
						const text = list.length ? '' : '暂无数据（您还没有创建记录）';
						return { items: list, statusText: text };
					} else {
						console.error(`[${new Date().toISOString()}] ${type} API返回失败:`, result);
						throw new Error(`获取${type}数据失败: ${JSON.stringify(result)}`);
					}
				} catch (error) {
					console.error(`[${new Date().toISOString()}] 加载${type}数据失败:`, error);
					return { items: [], statusText: '加载失败，请稍后重试' };
				}
			}

			/**
			 * 安全的内容解析函数
			 * @param {string} content - 原始内容
			 * @returns {object} 包含解析后内容和类型信息的对象
			 */
			function parseContent(content) {
				if (!content || typeof content !== 'string') {
					return {
						parsedContent: content || '',
						contentType: 'plain',
						indicator: ''
					};
				}

				const trimmedContent = content.trim();

				// 检测内容类型
				let contentType = 'plain';
				let indicator = '';

				// 检测 Markdown
				const markdownPatterns = [
					/^#{1,6}\s/, // 标题
					/\*\*.*?\*\*/, // 粗体
					/\*.*?\*/, // 斜体
					/\[.*?\]\(.*?\)/, // 链接
					/!\[.*?\]\(.*?\)/, // 图片
					/^[-*+]\s/, // 无序列表
					/^\d+\.\s/, // 有序列表
					/^>\s/, // 引用
					/`.*?`/, // 行内代码
					/^```[\s\S]*?```$/m, // 代码块
					/^\|.*\|$/, // 表格
					/^---$/, // 分割线
				];

				// 检测 HTML
				const htmlPatterns = [
					/<[^>]+>/, // HTML 标签
					/&[a-zA-Z]+;/, // HTML 实体
					/&#\d+;/, // 数字 HTML 实体
				];

				const hasMarkdown = markdownPatterns.some(pattern => pattern.test(trimmedContent));
				const hasHtml = htmlPatterns.some(pattern => pattern.test(trimmedContent));

				if (hasMarkdown && hasHtml) {
					contentType = 'markdown+html';
					indicator = ' (Markdown+HTML)';
				} else if (hasMarkdown) {
					contentType = 'markdown';
					indicator = ' (Markdown)';
				} else if (hasHtml) {
					contentType = 'html';
					indicator = ' (HTML)';
				}

				// 解析内容
				let parsedContent = trimmedContent;

				try {
					if (contentType === 'markdown' || contentType === 'markdown+html') {
						// 配置 Markdown 解析器
						marked.setOptions({
							breaks: true, // 支持换行
							gfm: true, // GitHub Flavored Markdown
							sanitize: false, // 不使用内置的 sanitize，我们使用 DOMPurify
						});

						// 解析 Markdown
						const htmlContent = marked.parse(trimmedContent);

						// 使用 DOMPurify 清理 HTML
						const cleanHtml = DOMPurify.sanitize(htmlContent, {
							ALLOWED_TAGS: [
								'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
								'p', 'br', 'hr',
								'ul', 'ol', 'li',
								'strong', 'b', 'em', 'i',
								'code', 'pre',
								'a', 'img',
								'blockquote',
								'table', 'thead', 'tbody', 'tr', 'th', 'td',
								'span', 'div'
							],
							ALLOWED_ATTR: [
								'href', 'src', 'alt', 'title', 'class', 'id',
								'target', 'rel', 'width', 'height'
							],
							ALLOW_DATA_ATTR: false,
							FORBID_TAGS: ['script', 'style', 'iframe', 'object', 'embed'],
							FORBID_ATTR: ['onerror', 'onload', 'onclick', 'onmouseover', 'onfocus', 'onblur']
						});

						parsedContent = cleanHtml;
					} else if (contentType === 'html') {
						// 直接清理 HTML
						const cleanHtml = DOMPurify.sanitize(trimmedContent, {
							ALLOWED_TAGS: [
								'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
								'p', 'br', 'hr',
								'ul', 'ol', 'li',
								'strong', 'b', 'em', 'i',
								'code', 'pre',
								'a', 'img',
								'blockquote',
								'table', 'thead', 'tbody', 'tr', 'th', 'td',
								'span', 'div'
							],
							ALLOWED_ATTR: [
								'href', 'src', 'alt', 'title', 'class', 'id',
								'target', 'rel', 'width', 'height'
							],
							ALLOW_DATA_ATTR: false,
							FORBID_TAGS: ['script', 'style', 'iframe', 'object', 'embed'],
							FORBID_ATTR: ['onerror', 'onload', 'onclick', 'onmouseover', 'onfocus', 'onblur']
						});

						parsedContent = cleanHtml;
					}
				} catch (error) {
					console.warn('内容解析失败，使用原始内容:', error);
					parsedContent = trimmedContent;
					contentType = 'plain';
					indicator = ' (解析失败)';
				}

				return {
					parsedContent,
					contentType,
					indicator
				};
			}

			/**
			 * 通用的时间轴渲染函数
			 */
			function renderTimeline(containerId, data, options = {}) {
				const container = document.getElementById(containerId);
				if (!container) return;

				const {
					iconText = '☆',
					titleField = 'title',
					timeField = 'time',
					contentField = 'content',
					imagesField = 'images',
					videosField = 'videos',
					isVersionLog = false,
					versionLogs = null,
					statusText = ''
				} = options;

				const items = Array.isArray(data) ? data : [];
				container.innerHTML = '';
				if (items.length === 0) {
					const text = statusText || '暂无数据';
					container.innerHTML = `<div class="timeline-empty">${text}</div>`;
					return;
				}

				items.forEach((item, index) => {
					const timelineItem = document.createElement('div');
					timelineItem.className = 'item';
					item.id && (timelineItem.id = item.id);

					// 创建左侧图标容器
					const leftDiv = document.createElement('div');
					leftDiv.className = 'left';

					const icon = document.createElement('icon');
					icon.className = 'icon';

					// 根据不同类型设置图标
					if (isVersionLog) {
						const isLastAndExpectNext = index === items.length - 1 && item.version === 'ExpectTheNextVersion';
						icon.textContent = isLastAndExpectNext ? '𝕹' : '𝕶';
					} else {
						icon.textContent = iconText;
					}

					leftDiv.appendChild(icon);

					// 创建右侧内容容器
					const rightDiv = document.createElement('div');
					rightDiv.className = 'right';

					// 创建标题
					const h4 = document.createElement('h4');
					h4.textContent = item[titleField];

					const timeSpan = document.createElement('span');
					timeSpan.className = 'itemTime';
					const originalTime = item[timeField] || '';
					// 直接使用后端返回的时间，不在渲染时处理
					timeSpan.textContent = originalTime;
					h4.appendChild(timeSpan);
					rightDiv.appendChild(h4);

					// 创建内容容器
					const contentDiv = document.createElement('div');
					contentDiv.className = 'content';

					if (isVersionLog) {
						// 版本日志使用有序列表
						const ol = document.createElement('ol');

						const contents = Array.isArray(item[contentField]) ? item[contentField] : [];
						contents.forEach((content, index) => {
							const li = document.createElement('li');
							li.style.position = 'relative'; // 为编辑按钮定位

							const strong = document.createElement('strong');
							strong.className = 'Ttime';
							const itemTime = content.itemTime || '';
							// 直接使用后端返回的时间，不在渲染时处理
							strong.textContent = itemTime;

							li.appendChild(strong);
							li.appendChild(document.createTextNode(' '));

							// 解析内容
							const parsedResult = parseContent(content.itemContent || '');

							const contentSpan = document.createElement('span');

							if (parsedResult.contentType === 'plain') {
								// 纯文本内容
								contentSpan.textContent = parsedResult.parsedContent;
								contentSpan.style.whiteSpace = 'pre-wrap';
							} else {
								// HTML 内容
								contentSpan.innerHTML = parsedResult.parsedContent;
								contentSpan.className = 'parsed-content';
							}

							li.appendChild(contentSpan);

							// 添加内容类型指示器
							if (parsedResult.indicator) {
								const indicatorSpan = document.createElement('span');
								indicatorSpan.className = 'content-type-indicator';
								indicatorSpan.textContent = parsedResult.indicator;
								li.appendChild(indicatorSpan);
							}

							// 为每个子条目添加编辑按钮（鼠标悬停显示）
							if (isUserLoggedIn() && (globalHasEditPermission || globalUserRole === 'developer' || globalUserRole === 'admin')) {
								// 为li元素添加CSS类，用于CSS悬停效果
								li.className = 'changelog-item-with-edit';

								const editItemButton = document.createElement('button');
								editItemButton.textContent = '✏️ 编辑';
								editItemButton.title = '编辑此条目';
								editItemButton.className = 'changelog-edit-button';
								editItemButton.onclick = () => showEditChangelogItemForm(item._id, item.version, index, content);
								li.appendChild(editItemButton);

								const deleteItemButton = document.createElement('button');
								deleteItemButton.textContent = '🗑️ 删除';
								deleteItemButton.title = '删除此条目';
								deleteItemButton.className = 'changelog-edit-button delete';
								deleteItemButton.onclick = async () => {
									if (!confirm('确定要删除此条目吗？')) return;
									try {
										const token = localStorage.getItem('token') || sessionStorage.getItem('token');
										const apiBaseUrl = window.OneLoveConfig?.apiBaseUrl || '/api';
										const resp = await fetch(`${apiBaseUrl}/changelog/${item._id}/items/${index}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
										let resJson; try { resJson = await resp.json(); } catch (_) { resJson = { success: false, message: `HTTP ${resp.status}` }; }
										if (resJson.success) { await loadAllData(); showSuccessMessage('删除成功'); } else { alert(`删除失败 (${resp.status}): ${resJson.message || ''}`); }
									} catch (err) { console.error('删除失败:', err); alert('删除失败，请稍后重试'); }
								};
								li.appendChild(deleteItemButton);
							}

							ol.appendChild(li);
						});

						contentDiv.appendChild(ol);
					} else {
						// 其他内容直接显示
						if (Array.isArray(item[contentField])) {
							item[contentField].forEach(content => {
								let contentText = '';
								if (typeof content === 'string') {
									contentText = content;
								} else if (content && typeof content === 'object') {
									contentText = content.itemContent || content.content || '';
								} else {
									contentText = String(content || '');
								}

								if (contentText.trim() !== '') {
									// 解析内容
									const parsedResult = parseContent(contentText);

									const p = document.createElement('p');

									if (parsedResult.contentType === 'plain') {
										// 纯文本内容
										p.textContent = parsedResult.parsedContent;
										p.style.whiteSpace = 'pre-wrap';
									} else {
										// HTML 内容
										p.innerHTML = parsedResult.parsedContent;
										p.className = 'parsed-content';
									}

									contentDiv.appendChild(p);

									// 添加内容类型指示器
									if (parsedResult.indicator) {
										const indicatorSpan = document.createElement('span');
										indicatorSpan.className = 'content-type-indicator';
										indicatorSpan.textContent = parsedResult.indicator;
										contentDiv.appendChild(indicatorSpan);
									}
								}
							});
						} else {
							const contentText = String(item[contentField] || '');
							if (contentText.trim() !== '') {
								// 解析内容
								const parsedResult = parseContent(contentText);

								const p2 = document.createElement('p');

								if (parsedResult.contentType === 'plain') {
									// 纯文本内容
									p2.textContent = parsedResult.parsedContent;
									p2.style.whiteSpace = 'pre-wrap';
								} else {
									// HTML 内容
									p2.innerHTML = parsedResult.parsedContent;
									p2.className = 'parsed-content';
								}

								contentDiv.appendChild(p2);

								// 添加内容类型指示器
								if (parsedResult.indicator) {
									const indicatorSpan = document.createElement('span');
									indicatorSpan.className = 'content-type-indicator';
									indicatorSpan.textContent = parsedResult.indicator;
									contentDiv.appendChild(indicatorSpan);
								}
							}
						}
					}

					rightDiv.appendChild(contentDiv);

					// 添加图片
					if (item[imagesField] && item[imagesField].length > 0) {
						const imagesDiv = document.createElement('div');
						imagesDiv.className = 'images';

						item[imagesField].forEach(image => {
							const img = document.createElement('img');
							img.src = image;
							img.alt = '图片';
							img.onclick = () => {
								const modal = document.createElement('div');
								modal.className = 'modal-overlay';
								const modalImg = document.createElement('img');
								modalImg.src = img.src;
								modalImg.className = 'modal-image';
								modal.appendChild(modalImg);
								modal.onclick = () => modal.remove();
								document.body.appendChild(modal);
							};
							imagesDiv.appendChild(img);
						});

						contentDiv.appendChild(imagesDiv);
					}

					// 添加视频
					if (item[videosField] && item[videosField].length > 0) {
						const videosDiv = document.createElement('div');
						videosDiv.className = 'videos';

						item[videosField].forEach(video => {
							const videoElement = document.createElement('video');
							videoElement.src = video;
							videoElement.controls = true;
							videoElement.preload = 'metadata';
							videosDiv.appendChild(videoElement);
						});

						contentDiv.appendChild(videosDiv);
					}

					// 添加编辑按钮（使用全局权限状态）
					try {
						if (isUserLoggedIn() && canEdit()) {
							// 创建按钮容器
							const actionsDiv = document.createElement('div');
							actionsDiv.className = 'timeline-actions';
							actionsDiv.style.display = 'flex'; // 直接显示

							// 如果是版本日志，添加"添加条目"按钮
							if (isVersionLog) {
								const addItemButton = document.createElement('button');
								addItemButton.textContent = '➕ 添加条目';
								addItemButton.style.background = '#27ae60';
								addItemButton.style.marginRight = '10px';
								addItemButton.onclick = () => showAddChangelogItemForm(item._id, item.version);
								actionsDiv.appendChild(addItemButton);
							}

							const editButton = document.createElement('button');
							editButton.textContent = '编辑';
							editButton.onclick = () => editTimelineItem(item, containerId);

							const deleteButton = document.createElement('button');
							deleteButton.textContent = '删除';
							deleteButton.onclick = () => deleteTimelineItem(item, containerId);

							actionsDiv.appendChild(editButton);
							actionsDiv.appendChild(deleteButton);
							rightDiv.appendChild(actionsDiv);

							// 管理员只能看到编辑按钮和添加条目按钮
							if (globalUserRole === 'admin') {
								deleteButton.style.display = 'none';
							}
						}
					} catch (error) {
						console.error('添加编辑按钮失败:', error);
					}

					// 组装时间轴项
					timelineItem.appendChild(leftDiv);
					timelineItem.appendChild(rightDiv);

					// 添加到容器
					container.appendChild(timelineItem);
				});

				// 版本日志特殊处理
				if (isVersionLog && versionLogs && versionLogs.length > 0) {
					const lastIndex = versionLogs.length - 1;
					if (versionLogs[lastIndex].version === 'ExpectTheNextVersion') {
						const lastTimelineItem = container.lastElementChild;
						if (lastTimelineItem) {
							lastTimelineItem.style.opacity = '0.7';
							lastTimelineItem.style.fontStyle = 'italic';
						}
					}

					// 为ExpectTheNextVersion设置ID为ExpectTheNextVersion
					// 为order数字类型最大的元素设置ID为lastUpdate
					if (isVersionLog && data && data.length > 0) {
						const timelineItems = container.querySelectorAll('.item');

						// 找到order数字类型最大的元素
						let maxOrderItem = null;
						let maxOrder = -Infinity;

						data.forEach((item, index) => {
							// 检查是否为ExpectTheNextVersion
							if (item.version === 'ExpectTheNextVersion') {
								timelineItems[index].id = 'ExpectTheNextVersion';
							}
							// 检查order是否为数字类型且最大
							else if (typeof item.order === 'number') {
								if (item.order > maxOrder) {
									maxOrder = item.order;
									maxOrderItem = { item, index };
								}
							}
						});

						// 如果找到了order最大的元素，设置其ID为lastUpdate
						if (maxOrderItem) {
							timelineItems[maxOrderItem.index].id = 'lastUpdate';
						}
					}
				}
			}



			// 全局用户权限状态
			let globalUserRole = 'guest';
			let globalHasEditPermission = false;
			let globalHasDeletePermission = false;

			// 页面加载完成后执行
			document.addEventListener('DOMContentLoaded', async function () {
				console.log('页面加载完成');

				// 第一步：检查登录状态和token
				console.log('=== 页面加载时token检查 ===');
				const localToken = localStorage.getItem('token');
				const sessionToken = sessionStorage.getItem('token');
				const token = localToken || sessionToken;
				console.log('localStorage token:', localToken ? `存在 (${localToken.length}字符)` : '不存在');
				console.log('sessionStorage token:', sessionToken ? `存在 (${sessionToken.length}字符)` : '不存在');
				console.log('最终使用token:', token ? `存在 (${token.length}字符)` : '不存在');

				// 清除缓存，确保获取最新的登录状态
				clearAllCache();

				// 第二步：检查用户权限
				globalUserRole = await getUserRole();
				globalHasEditPermission = await hasEditPermission();
				globalHasDeletePermission = await hasDeletePermission();
				console.log('用户角色:', globalUserRole, '编辑权限:', globalHasEditPermission, '删除权限:', globalHasDeletePermission);

				// 第三步：显示/隐藏管理按钮
				if (canEdit()) {
					document.getElementById('addMyPastBtn').style.display = 'inline-block';
					document.getElementById('addHealthBtn').style.display = 'inline-block';
					document.getElementById('addChangelogBtn').style.display = 'inline-block';
					console.log('显示管理按钮 - 用户角色:', globalUserRole);

					// 添加按钮事件监听器
					document.getElementById('addMyPastBtn').onclick = () => showAddForm('myPastData');
					document.getElementById('addHealthBtn').onclick = () => showAddForm('healthData');
					document.getElementById('addChangelogBtn').onclick = () => showAddChangelogForm();
				} else {
					console.log('隐藏管理按钮 - 用户角色:', globalUserRole);
				}

				// 第三步：加载所有数据
				await loadAllData();

				// 第四步：处理锚点跳转
				handleAnchorNavigation();

				// 第五步：添加防重复点击机制的更新日志
				addChangelogEntry();

				// 监听URL变化，处理锚点跳转
				window.addEventListener('hashchange', function () {
					console.log('URL锚点变化，重新处理跳转');
					handleAnchorNavigation();
				});
			});

			// 加载所有数据的函数
			async function loadAllData() {
				try {
					// 并行加载所有数据
					const [changelogPromise, myPastPromise, healthPromise] = await Promise.allSettled([
						loadChangelogFromAPI(),
						loadTimelineData('myPast'),
						loadTimelineData('health')
					]);

					// 处理changelog数据
					if (changelogPromise.status === 'fulfilled') {
						console.log('Changelog数据加载完成');
						// 在权限检查之后渲染changelog
						renderTimeline('versionLogContainer', changelogPromise.value, {
							isVersionLog: true,
							versionLogs: changelogPromise.value,
							titleField: 'version',
							timeField: 'time',
							contentField: 'content'
						});
					} else {
						console.error('Changelog数据加载失败:', changelogPromise.reason);
					}

					// 处理My Past数据
					if (myPastPromise.status === 'fulfilled') {
						const mp = myPastPromise.value || { items: [], statusText: '' };
						const list = Array.isArray(mp.items) ? mp.items : [];
						console.log('My Past数据:', list);
						renderTimeline('myPastContainer', list, {
							iconText: '📅', titleField: 'title', timeField: 'time', contentField: 'content', imagesField: 'images', videosField: 'videos',
							statusText: mp.statusText
						});
					}

					// 处理Health数据
					if (healthPromise.status === 'fulfilled') {
						const hp = healthPromise.value || { items: [], statusText: '' };
						const list = Array.isArray(hp.items) ? hp.items : [];
						console.log('Health数据:', list);
						renderTimeline('healthContainer', list, {
							iconText: '🏥', titleField: 'title', timeField: 'time', contentField: 'content', imagesField: 'images', videosField: 'videos',
							statusText: hp.statusText
						});
					}

					console.log('所有数据加载完成');
				} catch (error) {
					console.error('加载数据失败:', error);
				}
			}

			// 处理锚点跳转的函数
			function handleAnchorNavigation() {
				// 获取URL中的锚点
				const hash = window.location.hash;
				if (hash) {
					// console.log('检测到锚点:', hash);

					// 延迟执行，确保DOM完全渲染
					setTimeout(() => {
						const targetElement = document.querySelector(hash);
						if (targetElement) {
							// console.log('找到目标元素，执行跳转:', targetElement);
							targetElement.scrollIntoView({
								behavior: 'smooth',
								block: 'start'
							});

							// 添加高亮效果
							targetElement.style.transition = 'background-color 0.3s ease';
							targetElement.style.backgroundColor = 'rgba(22, 160, 133, 0.2)';
							setTimeout(() => {
								targetElement.style.backgroundColor = '';
							}, 2000);
						} else {
							console.log('未找到目标元素:', hash);
						}
					}, 500); // 等待500ms确保DOM渲染完成
				}
			}

			// 添加更新日志条目的函数
			async function addChangelogEntry() {
				try {
					// 检查是否已经添加过这个条目（避免重复添加）
					const existingEntry = localStorage.getItem('changelog_antiduplicate_added');
					if (existingEntry) {
						// console.log('更新日志条目已存在，跳过添加');
						return;
					}

					const token = localStorage.getItem('token') || sessionStorage.getItem('token');
					if (!token) {
						console.log('未找到token，跳过添加更新日志');
						return; // 如果没有token，不添加条目
					}

					// 检查用户权限，只有开发者才自动添加
					if (globalUserRole !== 'developer') {
						console.log('用户不是开发者，跳过自动添加更新日志');
						localStorage.setItem('changelog_antiduplicate_added', 'true');
						return;
					}

					const apiBaseUrl = window.OneLoveConfig?.apiBaseUrl || '/api';

					// 获取最新的版本ID（ExpectTheNextVersion）
					const response = await fetch(`${apiBaseUrl}/changelog?limit=100`);
					const result = await response.json();

					if (result.success && result.data.changelogs) {
						const changelogs = result.data.changelogs;
						const expectNextVersion = changelogs.find(item => item.version === 'ExpectTheNextVersion');

						if (expectNextVersion) {
							const newEntry = {
								itemTime: '2025-01-17 19:58:52',
								itemContent: '添加防重复点击机制：为所有网络请求操作（添加版本、提交条目、编辑等）添加按钮禁用状态管理，防止用户在网络请求慢的情况下多次点击，提升用户体验并减少服务器压力。'
							};

							// 调试信息
							console.log('自动添加更新日志 - 请求数据:', {
								versionId: expectNextVersion._id,
								itemContent: newEntry.itemContent,
								itemTime: newEntry.itemTime,
								token: token ? '存在' : '不存在'
							});

							// 使用与手动添加条目完全相同的请求格式
							const requestData = {
								itemContent: newEntry.itemContent
							};

							// 检查是否为开发者且选择手动设置时间
							const isDeveloper = globalUserRole === 'developer';
							if (isDeveloper) {
								// 开发者可以选择手动设置时间
								requestData.itemTime = newEntry.itemTime;
								requestData.useAutoTime = false;
							} else {
								// 非开发者只能使用自动时间
								requestData.useAutoTime = true;
							}

							console.log('最终请求数据:', requestData);

							const addResponse = await fetch(`${apiBaseUrl}/changelog/${expectNextVersion._id}/items`, {
								method: 'POST',
								headers: {
									'Authorization': `Bearer ${token}`,
									'Content-Type': 'application/json'
								},
								body: JSON.stringify(requestData)
							});

							// 调试响应信息
							console.log('自动添加更新日志 - 服务器响应:', {
								status: addResponse.status,
								statusText: addResponse.statusText,
								ok: addResponse.ok
							});

							if (!addResponse.ok) {
								const errorText = await addResponse.text();
								console.error('自动添加更新日志失败:', errorText);
							}

							if (addResponse.ok) {
								// 标记已添加，避免重复添加
								localStorage.setItem('changelog_antiduplicate_added', 'true');
								console.log('防重复点击机制更新日志已添加');
							} else {
								// 即使失败也标记为已添加，避免重复尝试
								localStorage.setItem('changelog_antiduplicate_added', 'true');
								console.log('防重复点击机制更新日志添加失败，但已标记为已添加');

								// 在控制台提供手动添加的提示
								console.log('如需手动添加此条目，请使用以下内容：');
								console.log('时间:', newEntry.itemTime);
								console.log('内容:', newEntry.itemContent);
							}
						}
					}
				} catch (error) {
					console.error('添加更新日志条目失败:', error);
					// 即使失败也标记为已添加，避免重复尝试
					localStorage.setItem('changelog_antiduplicate_added', 'true');
					console.log('由于错误，已标记更新日志为已添加状态');
				}
			}

			// 显示加载状态消息
			function showLoadingMessage(message) {
				// 移除已存在的加载消息
				hideLoadingMessage();

				const loadingDiv = document.createElement('div');
				loadingDiv.id = 'loadingMessage';
				loadingDiv.style.cssText = `
					position: fixed;
					top: 50%;
					left: 50%;
					transform: translate(-50%, -50%);
					background: rgba(0, 0, 0, 0.8);
					color: white;
					padding: 20px 30px;
					border-radius: 10px;
					z-index: 10000;
					font-size: 16px;
					text-align: center;
					box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
				`;
				loadingDiv.innerHTML = `
					<div style="margin-bottom: 10px;">
						<span style="animation: spin 1s linear infinite;">⏳</span>
					</div>
					<div>${message}</div>
				`;

				// 添加旋转动画样式
				const style = document.createElement('style');
				style.textContent = `
					@keyframes spin {
						from { transform: rotate(0deg); }
						to { transform: rotate(360deg); }
					}
				`;
				document.head.appendChild(style);

				document.body.appendChild(loadingDiv);
			}

			// 隐藏加载状态消息
			function hideLoadingMessage() {
				const loadingDiv = document.getElementById('loadingMessage');
				if (loadingDiv) {
					loadingDiv.remove();
				}
			}

			// 显示成功消息
			function showSuccessMessage(message) {
				// 移除已存在的成功消息
				const existingSuccess = document.getElementById('successMessage');
				if (existingSuccess) {
					existingSuccess.remove();
				}

				const successDiv = document.createElement('div');
				successDiv.id = 'successMessage';
				successDiv.style.cssText = `
					position: fixed;
					top: 50%;
					left: 50%;
					transform: translate(-50%, -50%);
					background: rgba(40, 167, 69, 0.9);
					color: white;
					padding: 20px 30px;
					border-radius: 10px;
					z-index: 10000;
					font-size: 16px;
					text-align: center;
					box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
					animation: fadeInOut 3s ease-in-out;
				`;
				successDiv.innerHTML = `
					<div style="margin-bottom: 10px; font-size: 24px;">✅</div>
					<div>${message}</div>
				`;

				// 添加淡入淡出动画样式
				const style = document.createElement('style');
				style.textContent = `
					@keyframes fadeInOut {
						0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
						20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
						80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
						100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
					}
				`;
				document.head.appendChild(style);

				document.body.appendChild(successDiv);

				// 3秒后自动移除
				setTimeout(() => {
					if (successDiv.parentNode) {
						successDiv.remove();
					}
				}, 3000);
			}

			// 编辑时间轴项
			async function editTimelineItem(item, containerId) {
				console.log('编辑项目:', item, '用户角色:', globalUserRole, '编辑权限:', globalHasEditPermission);

				if (canEdit()) {
					// 根据容器类型确定编辑类型
					if (containerId === 'versionLogContainer') {
						showEditChangelogForm(item);
					} else {
						showEditTimelineForm(item, containerId);
					}
				} else {
					alert('权限不足，只有开发者和管理员可以编辑');
				}
			}

			// 显示编辑时间轴表单
			function showEditTimelineForm(item, containerId) {
				const formHtml = `
					<div id="editFormOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center;">
						<div style="background: white; padding: 20px; border-radius: 10px; width: 80%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
							<h3>编辑条目</h3>
							<form id="editItemForm">
								<input type="hidden" id="editItemId" value="${item._id}">
								<input type="hidden" id="editContainerId" value="${containerId}">
								<div style="margin-bottom: 15px;">
									<label>标题:</label><br>
									<input type="text" id="editTitle" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" value="${item.title || ''}">
								</div>
								<div style="margin-bottom: 15px;">
									<label>时间:</label><br>
									<input type="text" id="editTime" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" value="${item.time || ''}" placeholder="格式: YYYY-MM-DD HH:MM:SS">
								</div>
								<div style="margin-bottom: 15px;">
									<label>内容: <span style="font-size: 0.8em; color: #666;">(支持 Markdown 和 HTML)</span></label><br>
									<textarea id="editContent" required style="width: 100%; height: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="请输入内容...支持 Markdown 语法如 **粗体**、*斜体*、[链接](url) 等"></textarea>
									<div style="margin-top: 5px; font-size: 0.8em; color: #666;">
										<strong>支持格式:</strong> Markdown (**, *, #, >, \`, \`\`\`), HTML 标签 (安全过滤)
									</div>
									<button type="button" onclick="previewContent('editContent')" style="margin-top: 5px; padding: 4px 8px; background: #16A085; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.8em;">预览内容</button>
								</div>
								<div style="margin-bottom: 15px;">
									<label>图片URL (可选，多个用逗号分隔):</label><br>
									<input type="text" id="editImages" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" value="${item.images ? item.images.join(', ') : ''}" placeholder="例如: /images/photo1.jpg, /images/photo2.jpg">
								</div>
								<div style="margin-bottom: 15px;">
									<label>视频URL (可选，多个用逗号分隔):</label><br>
									<input type="text" id="editVideos" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" value="${item.videos ? item.videos.join(', ') : ''}" placeholder="例如: /videos/video1.mp4, /videos/video2.mp4">
								</div>
								<div style="text-align: right;">
									<button type="button" onclick="closeEditForm()" style="background: #95a5a6; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 10px;">取消</button>
									<button type="submit" style="background: #16A085; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">保存</button>
								</div>
							</form>
						</div>
					</div>
				`;

				document.body.insertAdjacentHTML('beforeend', formHtml);

				// 添加ESC键关闭功能
				const overlay = document.getElementById('editFormOverlay');
				overlay.addEventListener('keydown', function (e) {
					if (e.key === 'Escape') {
						closeEditForm();
					}
				});

				// 添加表单提交事件
				document.getElementById('editItemForm').onsubmit = (e) => {
					e.preventDefault();
					submitEditTimeline();
				};

				// 设置textarea的值
				const textarea = document.getElementById('editContent');
				if (textarea) {
					textarea.value = item.content && item.content[0] ? item.content[0].itemContent : '';
				}
			}

			// 显示编辑版本表单
			function showEditChangelogForm(item) {
				const formHtml = `
					<div id="editChangelogFormOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center;">
						<div style="background: white; padding: 20px; border-radius: 10px; width: 80%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
							<h3>编辑版本</h3>
							<form id="editChangelogForm">
								<input type="hidden" id="editChangelogId" value="${item._id}">
								<div style="margin-bottom: 15px;">
									<label>版本号:</label><br>
									<input type="text" id="editVersion" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" value="${item.version || ''}" placeholder="例如: v5.0.5">
								</div>
								<div style="margin-bottom: 15px;">
									<label>时间:</label><br>
									<input type="text" id="editChangelogTime" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" value="${item.time || ''}" placeholder="格式: YYYY-MM-DD HH:MM:SS">
								</div>
								<div style="text-align: right;">
									<button type="button" onclick="closeEditChangelogForm()" style="background: #95a5a6; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 10px;">取消</button>
									<button type="submit" style="background: #16A085; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">保存</button>
								</div>
							</form>
						</div>
					</div>
				`;

				document.body.insertAdjacentHTML('beforeend', formHtml);

				// 添加ESC键关闭功能
				const overlay = document.getElementById('editChangelogFormOverlay');
				overlay.addEventListener('keydown', function (e) {
					if (e.key === 'Escape') {
						closeEditChangelogForm();
					}
				});

				// 添加表单提交事件
				document.getElementById('editChangelogForm').onsubmit = (e) => {
					e.preventDefault();
					submitEditChangelog();
				};
			}

			// 关闭编辑表单
			function closeEditForm() {
				const overlay = document.getElementById('editFormOverlay');
				if (overlay) {
					overlay.remove();
				}
			}

			// 关闭编辑版本表单
			function closeEditChangelogForm() {
				const overlay = document.getElementById('editChangelogFormOverlay');
				if (overlay) {
					overlay.remove();
				}
			}

			// 显示编辑子条目表单
			function showEditChangelogItemForm(changelogId, version, itemIndex, content) {
				const formHtml = `
					<div id="editChangelogItemFormOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center;">
						<div style="background: white; padding: 20px; border-radius: 10px; width: 80%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
							<h3>编辑子条目 - ${version}</h3>
							<form id="editChangelogItemForm">
								<input type="hidden" id="editChangelogItemId" value="${changelogId}">
								<input type="hidden" id="editChangelogItemIndex" value="${itemIndex}">
								<div style="margin-bottom: 15px;">
									<label>时间设置:</label><br>
									<select id="editItemTimeSetting" onchange="toggleEditItemTimeInput()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px;">
										<option value="auto" selected>自动设置时间（UTC+8）</option>
										<option value="manual">手动设置时间</option>
									</select>
									<input type="datetime-local" id="editItemManualTimeInput" step="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; display: none;" placeholder="选择时间">
								</div>
								<div style="margin-bottom: 15px;">
									<label>内容: <span style="font-size: 0.8em; color: #666;">(支持 Markdown 和 HTML)</span></label><br>
									<textarea id="editChangelogItemContent" required style="width: 100%; height: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="请输入内容...支持 Markdown 语法如 **粗体**、*斜体*、[链接](url) 等">${content.itemContent || ''}</textarea>
									<div style="margin-top: 5px; font-size: 0.8em; color: #666;">
										<strong>支持格式:</strong> Markdown (**, *, #, >, \`, \`\`\`), HTML 标签 (安全过滤)
									</div>
									<button type="button" onclick="previewContent('editChangelogItemContent')" style="margin-top: 5px; padding: 4px 8px; background: #16A085; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.8em;">预览内容</button>
								</div>
								<div style="text-align: right;">
									<button type="button" onclick="closeEditChangelogItemForm()" style="background: #95a5a6; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 10px;">取消</button>
									<button type="submit" style="background: #16A085; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">保存</button>
								</div>
							</form>
						</div>
					</div>
				`;

				document.body.insertAdjacentHTML('beforeend', formHtml);

				// 添加ESC键关闭功能
				const overlay = document.getElementById('editChangelogItemFormOverlay');
				overlay.addEventListener('keydown', function (e) {
					if (e.key === 'Escape') {
						closeEditChangelogItemForm();
					}
				});

				// 添加表单提交事件
				document.getElementById('editChangelogItemForm').onsubmit = (e) => {
					e.preventDefault();
					submitEditChangelogItem();
				};
			}

			// 关闭编辑子条目表单
			function closeEditChangelogItemForm() {
				const overlay = document.getElementById('editChangelogItemFormOverlay');
				if (overlay) {
					overlay.remove();
				}
			}

			// 提交编辑时间轴
			async function submitEditTimeline() {
				// 防止重复提交
				const submitBtn = document.querySelector('#editItemForm button[type="submit"]');
				if (submitBtn) {
					submitBtn.disabled = true;
					submitBtn.textContent = '⏳ 保存中...';
				}

				try {
					const itemId = document.getElementById('editItemId').value;
					const containerId = document.getElementById('editContainerId').value;
					const title = document.getElementById('editTitle').value.trim();
					const time = document.getElementById('editTime').value.trim();
					const content = document.getElementById('editContent').value.trim();
					const images = document.getElementById('editImages').value.trim();
					const videos = document.getElementById('editVideos').value.trim();

					if (!title || !time || !content) {
						alert('请填写必填字段');
						return;
					}

					const token = localStorage.getItem('token') || sessionStorage.getItem('token');
					const apiBaseUrl = window.OneLoveConfig?.apiBaseUrl || '/api';

					const requestData = {
						title: title,
						time: time,
						content: [{
							itemContent: content
						}],
						images: images ? images.split(',').map(url => url.trim()) : [],
						videos: videos ? videos.split(',').map(url => url.trim()) : []
					};

					const response = await fetch(`${apiBaseUrl}/timeline-data/${itemId}`, {
						method: 'PUT',
						headers: {
							'Authorization': `Bearer ${token}`,
							'Content-Type': 'application/json'
						},
						body: JSON.stringify(requestData)
					});

					const result = await response.json();

					if (result.success) {
						// 关闭表单
						closeEditForm();

						// 显示加载状态
						showLoadingMessage('编辑成功，正在刷新数据...');

						// 重新加载数据
						const type = containerId === 'myPastContainer' ? 'myPast' : 'health';
						const data = await loadTimelineData(type);
						renderTimeline(containerId, data, {
							iconText: containerId === 'myPastContainer' ? '📅' : '🏥',
							titleField: 'title',
							timeField: 'time',
							contentField: 'content',
							imagesField: 'images',
							videosField: 'videos'
						});

						// 隐藏加载状态
						hideLoadingMessage();

						// 显示成功提示
						showSuccessMessage('编辑成功！');
					} else {
						alert('编辑失败: ' + result.message);
					}
				} catch (error) {
					console.error('编辑失败:', error);
					alert('编辑失败，请稍后重试');
				} finally {
					// 恢复按钮状态
					const submitBtn = document.querySelector('#editItemForm button[type="submit"]');
					if (submitBtn) {
						submitBtn.disabled = false;
						submitBtn.textContent = '保存';
					}
				}
			}

			// 提交编辑版本
			async function submitEditChangelog() {
				try {
					const changelogId = document.getElementById('editChangelogId').value;
					const version = document.getElementById('editVersion').value.trim();
					const time = document.getElementById('editChangelogTime').value.trim();

					if (!version || !time) {
						alert('请填写必填字段');
						return;
					}

					const token = localStorage.getItem('token') || sessionStorage.getItem('token');
					const apiBaseUrl = window.OneLoveConfig?.apiBaseUrl || '/api';

					const requestData = {
						version: version,
						time: formatTimeWithSeconds(time)
					};

					const response = await fetch(`${apiBaseUrl}/changelog/${changelogId}`, {
						method: 'PUT',
						headers: {
							'Authorization': `Bearer ${token}`,
							'Content-Type': 'application/json'
						},
						body: JSON.stringify(requestData)
					});

					const result = await response.json();

					if (result.success) {
						// 关闭表单
						closeEditChangelogForm();

						// 显示加载状态
						showLoadingMessage('编辑成功，正在刷新数据...');

						// 重新加载数据
						await loadAllData();

						// 重新处理锚点跳转
						handleAnchorNavigation();

						// 隐藏加载状态
						hideLoadingMessage();

						// 显示成功提示
						showSuccessMessage('编辑成功！');
					} else {
						alert('编辑失败: ' + result.message);
					}
				} catch (error) {
					console.error('编辑失败:', error);
					alert('编辑失败，请稍后重试');
				}
			}

			// 提交编辑子条目
			async function submitEditChangelogItem() {
				try {
					const changelogId = document.getElementById('editChangelogItemId').value;
					const itemIndex = parseInt(document.getElementById('editChangelogItemIndex').value);
					const itemContent = document.getElementById('editChangelogItemContent').value.trim();
					const timeSetting = document.getElementById('editItemTimeSetting');
					const manualTimeInput = document.getElementById('editItemManualTimeInput');
					const useAutoTime = !timeSetting || timeSetting.value === 'auto';
					let itemTime = '';

					if (useAutoTime) {
						// 自动设置时间（UTC+8）
						const now = new Date();
						const utc8Time = new Date(now.getTime() + (8 * 60 * 60 * 1000));
						itemTime = formatTimeWithSeconds(utc8Time.toISOString().slice(0, 19).replace('T', ' '));
					} else if (manualTimeInput && manualTimeInput.value) {
						// 手动设置时间
						const selectedTime = new Date(manualTimeInput.value);
						const manualUtc8Time = new Date(selectedTime.getTime() + (8 * 60 * 60 * 1000));
						itemTime = formatTimeWithSeconds(manualUtc8Time.toISOString().slice(0, 19).replace('T', ' '));
					}

					if (!itemContent) {
						alert('请填写必填字段');
						return;
					}

					const token = localStorage.getItem('token') || sessionStorage.getItem('token');
					const apiBaseUrl = window.OneLoveConfig?.apiBaseUrl || '/api';

					// 直接调用子条目更新接口
					const response = await fetch(`${apiBaseUrl}/changelog/${changelogId}/items/${itemIndex}`, {
						method: 'PUT',
						headers: {
							'Authorization': `Bearer ${token}`,
							'Content-Type': 'application/json'
						},
						body: JSON.stringify({ itemTime, itemContent, useAutoTime })
					});

					const result = await response.json();

					if (result.success) {
						// 关闭表单
						closeEditChangelogItemForm();

						// 重新加载数据
						await loadAllData();

						// 重新处理锚点跳转
						handleAnchorNavigation();

						// 显示成功提示
						showSuccessMessage('编辑成功！');
					} else {
						alert('编辑失败: ' + result.message);
					}
				} catch (error) {
					console.error('编辑失败:', error);
					alert('编辑失败，请稍后重试');
				}
			}

			// 删除时间轴项
			async function deleteTimelineItem(item, containerId) {
				console.log('删除项目:', item, '用户角色:', globalUserRole, '删除权限:', globalHasDeletePermission);

				if (globalHasDeletePermission) {
					if (confirm('确定要删除这个项目吗？此操作不可恢复！')) {
						try {
							const token = localStorage.getItem('token') || sessionStorage.getItem('token');
							const apiBaseUrl = window.OneLoveConfig?.apiBaseUrl || '/api';

							// 根据容器类型确定删除的API端点
							let deleteUrl;
							if (containerId === 'versionLogContainer') {
								deleteUrl = `${apiBaseUrl}/changelog/${item._id}`;
							} else {
								deleteUrl = `${apiBaseUrl}/timeline-data/${item._id}`;
							}

							const response = await fetch(deleteUrl, {
								method: 'DELETE',
								headers: {
									'Authorization': `Bearer ${token}`,
									'Content-Type': 'application/json'
								}
							});

							const result = await response.json();

							if (result.success) {
								// 显示加载状态
								showLoadingMessage('删除成功，正在刷新数据...');

								// 重新加载数据
								await loadAllData();

								// 重新处理锚点跳转
								handleAnchorNavigation();

								// 隐藏加载状态
								hideLoadingMessage();

								// 显示成功提示
								showSuccessMessage('删除成功！');
							} else {
								alert('删除失败: ' + result.message);
							}
						} catch (error) {
							console.error('删除失败:', error);
							alert('删除失败，请稍后重试');
						}
					}
				} else {
					alert('权限不足，只有开发者可以删除项目');
				}
			}

			// 用户角色缓存
			let userRoleCache = null;
			let userRoleTimestamp = 0;
			const ROLE_CACHE_DURATION = 5 * 60 * 1000; // 5分钟缓存

			// 获取用户角色（带缓存，减少日志输出）
			async function getUserRole() {
				try {
					const token = localStorage.getItem('token') || sessionStorage.getItem('token');
					if (!token) {
						return 'guest';
					}

					// 检查缓存
					const now = Date.now();
					if (userRoleCache && (now - userRoleTimestamp) < ROLE_CACHE_DURATION) {
						return userRoleCache;
					}

					// 从API获取用户信息
					const apiBaseUrl = window.OneLoveConfig?.apiBaseUrl || '/api';
					const response = await fetch(`${apiBaseUrl}/test/user`, {
						headers: {
							'Authorization': `Bearer ${token}`,
							'Content-Type': 'application/json'
						}
					});

					if (response.ok) {
						const result = await response.json();
						if (result.success && result.data && result.data.user) {
							const user = result.data.user;
							const username = user.username || user.name || '';
							const role = user.role || '';

							console.log('从API获取用户信息:', username, '角色:', role);

							// 确定最终角色
							let finalRole = 'guest';
							if (role) {
								if (role === 'developer' || role === 'dev') finalRole = 'developer';
								else if (role === 'admin' || role === 'administrator') finalRole = 'admin';
								else if (role === 'user' || role === 'normal') finalRole = 'user';
							}

							// 更新缓存
							userRoleCache = finalRole;
							userRoleTimestamp = now;

							return finalRole;
						}
					}

					return 'guest';
				} catch (error) {
					console.error('获取用户角色失败:', error);
					return 'guest';
				}
			}

			// 检查用户是否是开发者
			async function isDeveloper() {
				const role = await getUserRole();
				return role === 'developer';
			}

			// 检查用户是否是管理员
			async function isAdmin() {
				const role = await getUserRole();
				return role === 'admin';
			}

			// 检查用户是否有编辑权限（开发者和管理员）
			async function hasEditPermission() {
				const role = await getUserRole();
				return role === 'developer' || role === 'admin';
			}

			// 检查用户是否有删除权限（只有开发者）
			async function hasDeletePermission() {
				const role = await getUserRole();
				return role === 'developer';
			}

			// 简化的权限检查函数
			function canEdit() {
				return globalUserRole === 'developer' || globalUserRole === 'admin';
			}

			function canDelete() {
				return globalUserRole === 'developer';
			}

			// 登录状态缓存
			let loginStatusCache = null;
			let loginStatusTimestamp = 0;
			const LOGIN_CACHE_DURATION = 30 * 1000; // 30秒缓存

			// 检查用户是否已登录（带缓存，减少日志输出）
			function isUserLoggedIn() {
				// 检查缓存
				const now = Date.now();
				if (loginStatusCache !== null && (now - loginStatusTimestamp) < LOGIN_CACHE_DURATION) {
					return loginStatusCache;
				}

				const localToken = localStorage.getItem('token');
				const sessionToken = sessionStorage.getItem('token');
				const token = localToken || sessionToken;
				const hasToken = !!token;

				// 只在第一次检查时输出详细信息
				if (loginStatusCache === null) {
					console.log('=== 登录状态检查 ===');
					console.log('localStorage token:', localToken ? `存在 (${localToken.length}字符)` : '不存在');
					console.log('sessionStorage token:', sessionToken ? `存在 (${sessionToken.length}字符)` : '不存在');
					console.log('最终使用token:', token ? `存在 (${token.length}字符)` : '不存在');
					console.log('登录状态:', hasToken);
					console.log('========================');
				}

				// 更新缓存
				loginStatusCache = hasToken;
				loginStatusTimestamp = now;

				return hasToken;
			}

			// 清除所有缓存
			function clearAllCache() {
				loginStatusCache = null;
				loginStatusTimestamp = 0;
				userRoleCache = null;
				userRoleTimestamp = 0;
				console.log('所有缓存已清除');
			}

			// 手动检查用户信息（调试用）
			async function checkTokenContent() {
				const localToken = localStorage.getItem('token');
				const sessionToken = sessionStorage.getItem('token');
				const token = localToken || sessionToken;

				console.log('=== 用户信息检查 ===');
				if (token) {
					console.log('Token存在，长度:', token.length);

					// 显示当前缓存状态
					console.log('登录状态缓存:', loginStatusCache);
					console.log('用户角色缓存:', userRoleCache);

					try {
						// 清除缓存，强制重新获取
						clearAllCache();

						// 从API获取用户信息
						const apiBaseUrl = window.OneLoveConfig?.apiBaseUrl || '/api';
						const response = await fetch(`${apiBaseUrl}/test/user`, {
							headers: {
								'Authorization': `Bearer ${token}`,
								'Content-Type': 'application/json'
							}
						});

						if (response.ok) {
							const result = await response.json();
							if (result.success && result.data && result.data.user) {
								console.log('API返回的用户信息:', result.data.user);
								console.log('用户名:', result.data.user.username || result.data.user.name || '未找到');
								console.log('角色:', result.data.user.role || '未找到');
								console.log('邮箱:', result.data.user.email || '未找到');
							} else {
								console.log('API返回数据格式错误:', result);
							}
						} else {
							console.log('API请求失败，状态码:', response.status);
							const errorText = await response.text();
							console.log('错误信息:', errorText);
						}
					} catch (error) {
						console.log('API请求异常:', error);
					}
				} else {
					console.log('没有找到token');
				}
				console.log('==================');
			}

			// 显示添加表单
			function showAddForm(type) {
				const formHtml = `
					<div id="addFormOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center;">
						<div style="background: white; padding: 20px; border-radius: 10px; width: 80%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
							<h3>添加新条目 (${type === 'myPastData' ? 'My Past' : 'Health'})</h3>
							<form id="addItemForm">
								<div style="margin-bottom: 15px;">
									<label>标题:</label><br>
									<input type="text" id="addTitle" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
								</div>
								<div style="margin-bottom: 15px;">
									<label>时间:</label><br>
									<input type="text" value="自动使用创建时间" disabled style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5; color: #666;">
								</div>
								<div style="margin-bottom: 15px;">
									<label>内容:</label><br>
									<textarea id="addContent" required style="width: 100%; height: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="请输入内容..."></textarea>
								</div>
								<div style="margin-bottom: 15px;">
									<label>图片URL (可选，多个用逗号分隔):</label><br>
									<input type="text" id="addImages" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="例如: /images/photo1.jpg, /images/photo2.jpg">
								</div>
								<div style="margin-bottom: 15px;">
									<label>视频URL (可选，多个用逗号分隔):</label><br>
									<input type="text" id="addVideos" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="例如: /videos/video1.mp4, /videos/video2.mp4">
								</div>
								<div style="text-align: right;">
									<button type="button" onclick="closeAddForm()" style="background: #95a5a6; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 10px;">取消</button>
									<button type="submit" style="background: #16A085; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">添加</button>
								</div>
							</form>
						</div>
					</div>
				`;

				document.body.insertAdjacentHTML('beforeend', formHtml);

				// 添加ESC键关闭功能
				const overlay = document.getElementById('addFormOverlay');
				overlay.addEventListener('keydown', function (e) {
					if (e.key === 'Escape') {
						closeAddForm();
					}
				});

				// 添加表单提交事件
				document.getElementById('addItemForm').onsubmit = (e) => {
					e.preventDefault();
					submitNewItem(type);
				};
			}

			// 显示添加更新日志表单
			async function showAddChangelogForm() {
				// 防止重复点击
				const addBtn = document.getElementById('addChangelogBtn');
				if (addBtn) {
					addBtn.disabled = true;
					addBtn.textContent = '⏳ 加载中...';
				}

				try {
					// 检查是否为开发者
					const isDeveloper = globalUserRole === 'developer';

					// 获取最大的order值
					const maxOrder = await getMaxOrderValue();
					const defaultOrder = maxOrder + 1;

					const timeSection = isDeveloper ? `
					<div style="margin-bottom: 15px;">
						<label>时间设置:</label><br>
						<select id="versionTimeSetting" onchange="toggleVersionTimeInput()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px;">
							<option value="auto">自动设置时间（UTC+8）</option>
							<option value="manual">手动设置时间</option>
						</select>
						<input type="datetime-local" id="versionManualTimeInput" step="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; display: none;" placeholder="选择时间">
					</div>
				` : `
					<div style="margin-bottom: 15px;">
						<label>时间:</label><br>
						<input type="text" value="自动使用创建时间（UTC+8）" disabled style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5; color: #666;">
					</div>
				`;

					const formHtml = `
					<div id="addChangelogFormOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center;">
						<div style="background: white; padding: 20px; border-radius: 10px; width: 80%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
							<h3>添加新版本</h3>
							<form id="addChangelogForm">
								<div style="margin-bottom: 15px;">
									<label>版本号:</label><br>
									<input type="text" id="addVersion" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="例如: v5.0.5">
								</div>
								<div style="margin-bottom: 15px;">
									<label>排序值 (当前最大: ${maxOrder}):</label><br>
									<input type="number" id="addOrder" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" value="${defaultOrder}" min="1" placeholder="请输入排序值">
								</div>
								${timeSection}
								<div style="text-align: right;">
									<button type="button" onclick="closeAddChangelogForm()" style="background: #95a5a6; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 10px;">取消</button>
									<button type="submit" style="background: #16A085; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">添加版本</button>
								</div>
							</form>
						</div>
					</div>
				`;

					document.body.insertAdjacentHTML('beforeend', formHtml);

					// 添加ESC键关闭功能
					const overlay = document.getElementById('addChangelogFormOverlay');
					overlay.addEventListener('keydown', function (e) {
						if (e.key === 'Escape') {
							closeAddChangelogForm();
						}
					});

					// 添加表单提交事件
					document.getElementById('addChangelogForm').onsubmit = (e) => {
						e.preventDefault();
						submitNewChangelog();
					};
				} catch (error) {
					console.error('加载表单失败:', error);
					alert('加载表单失败，请稍后重试');
				} finally {
					// 恢复按钮状态
					const addBtn = document.getElementById('addChangelogBtn');
					if (addBtn) {
						addBtn.disabled = false;
						addBtn.textContent = '➕ 添加新版本';
					}
				}
			}

			// 显示添加条目表单
			function showAddChangelogItemForm(versionId, versionName) {
				// 检查是否为开发者
				const isDeveloper = globalUserRole === 'developer';

				const timeSection = isDeveloper ? `
					<div style="margin-bottom: 15px;">
						<label>时间设置:</label><br>
						<select id="timeSetting" onchange="toggleTimeInput()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px;">
							<option value="auto">自动设置时间（UTC+8）</option>
							<option value="manual">手动设置时间</option>
						</select>
						<input type="datetime-local" id="manualTimeInput" step="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; display: none;" placeholder="选择时间">
					</div>
				` : `
					<div style="margin-bottom: 15px;">
						<label>时间:</label><br>
						<input type="text" value="自动使用创建时间（UTC+8）" disabled style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5; color: #666;">
					</div>
				`;

				const formHtml = `
					<div id="addChangelogItemFormOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center;">
						<div style="background: white; padding: 20px; border-radius: 10px; width: 80%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
							<h3>添加条目到 ${versionName}</h3>
							<form id="addChangelogItemForm">
								<input type="hidden" id="addItemVersionId" value="${versionId}">
								<div style="margin-bottom: 15px;">
									<label>条目内容: <span style="font-size: 0.8em; color: #666;">(支持 Markdown 和 HTML)</span></label><br>
									<textarea id="addChangelogItemContent" required style="width: 100%; height: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="请输入条目内容...支持 Markdown 语法如 **粗体**、*斜体*、[链接](url) 等"></textarea>
									<div style="margin-top: 5px; font-size: 0.8em; color: #666;">
										<strong>支持格式:</strong> Markdown (**, *, #, >, \`, \`\`\`), HTML 标签 (安全过滤)
									</div>
									<button type="button" onclick="previewContent('addChangelogItemContent')" style="margin-top: 5px; padding: 4px 8px; background: #16A085; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.8em;">预览内容</button>
								</div>
								${timeSection}
								<div style="text-align: right;">
									<button type="button" onclick="closeAddChangelogItemForm()" style="background: #95a5a6; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 10px;">取消</button>
									<button type="submit" style="background: #16A085; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">添加条目</button>
								</div>
							</form>
						</div>
					</div>
				`;

				document.body.insertAdjacentHTML('beforeend', formHtml);

				// 添加ESC键关闭功能
				const overlay = document.getElementById('addChangelogItemFormOverlay');
				overlay.addEventListener('keydown', function (e) {
					if (e.key === 'Escape') {
						closeAddChangelogItemForm();
					}
				});

				// 添加表单提交事件
				document.getElementById('addChangelogItemForm').onsubmit = (e) => {
					e.preventDefault();
					submitNewChangelogItem();
				};
			}

			// 关闭添加表单
			function closeAddForm() {
				const overlay = document.getElementById('addFormOverlay');
				if (overlay) {
					overlay.remove();
				}
			}

			// 关闭添加更新日志表单
			function closeAddChangelogForm() {
				const overlay = document.getElementById('addChangelogFormOverlay');
				if (overlay) {
					overlay.remove();
				}
			}

			/**
			* 格式化时间字符串，确保包含秒级精度
			* @param {string} timeStr - 输入的时间字符串
			* @returns {string} 包含秒级精度的时间字符串
			*/
			function formatTimeWithSeconds(timeStr) {
				if (!timeStr) return '';

				// 检查时间格式是否已包含秒
				const timeParts = timeStr.split(' ');
				if (timeParts.length < 2) return timeStr;

				const datePart = timeParts[0];
				let timePart = timeParts[1];

				// 检查时间部分是否包含秒
				if (timePart.split(':').length === 2) {
					// 只有小时和分钟，添加秒
					timePart += ':00';
				}

				return `${datePart} ${timePart}`;
			}

			// 切换时间输入显示
			function toggleTimeInput() {
				const timeSetting = document.getElementById('timeSetting');
				const manualTimeInput = document.getElementById('manualTimeInput');

				if (timeSetting && manualTimeInput) {
					if (timeSetting.value === 'manual') {
						manualTimeInput.style.display = 'block';
						// 设置默认值为当前时间（UTC+8）
						const now = new Date();
						const utc8Time = new Date(now.getTime() + (8 * 60 * 60 * 1000));
						manualTimeInput.value = utc8Time.toISOString().slice(0, 19);
					} else {
						manualTimeInput.style.display = 'none';
					}
				}
			}

			// 切换版本时间输入显示
			function toggleVersionTimeInput() {
				const versionTimeSetting = document.getElementById('versionTimeSetting');
				const versionManualTimeInput = document.getElementById('versionManualTimeInput');

				if (versionTimeSetting && versionManualTimeInput) {
					if (versionTimeSetting.value === 'manual') {
						versionManualTimeInput.style.display = 'block';
						// 设置默认值为当前时间（UTC+8）
						const now = new Date();
						const utc8Time = new Date(now.getTime() + (8 * 60 * 60 * 1000));
						versionManualTimeInput.value = utc8Time.toISOString().slice(0, 19);
					} else {
						versionManualTimeInput.style.display = 'none';
					}
				}
			}


			// 切换编辑子条目时间输入显示
			function toggleEditItemTimeInput() {
				const editItemTimeSetting = document.getElementById('editItemTimeSetting');
				const editItemManualTimeInput = document.getElementById('editItemManualTimeInput');

				if (editItemTimeSetting && editItemManualTimeInput) {
					if (editItemTimeSetting.value === 'manual') {
						editItemManualTimeInput.style.display = 'block';
						// 设置默认值为当前时间（UTC+8）
						const now = new Date();
						const utc8Time = new Date(now.getTime() + (8 * 60 * 60 * 1000));
						editItemManualTimeInput.value = utc8Time.toISOString().slice(0, 19);
					} else {
						editItemManualTimeInput.style.display = 'none';
					}
				}
			}

			// 关闭添加条目表单
			function closeAddChangelogItemForm() {
				const overlay = document.getElementById('addChangelogItemFormOverlay');
				if (overlay) {
					overlay.remove();
				}
			}

			// 提交新条目
			async function submitNewItem(type) {
				try {
					const title = document.getElementById('addTitle').value.trim();
					const content = document.getElementById('addContent').value.trim();
					const images = document.getElementById('addImages').value.trim();
					const videos = document.getElementById('addVideos').value.trim();

					if (!title || !content) {
						alert('请填写必填字段');
						return;
					}

					const token = localStorage.getItem('token') || sessionStorage.getItem('token');
					const apiBaseUrl = window.OneLoveConfig?.apiBaseUrl || '/api';

					const requestData = {
						type: type === 'myPastData' ? 'myPast' : 'health',
						title: title,
						content: [{
							itemContent: content
						}],
						images: images ? images.split(',').map(url => url.trim()) : [],
						videos: videos ? videos.split(',').map(url => url.trim()) : []
					};

					const response = await fetch(`${apiBaseUrl}/timeline-data`, {
						method: 'POST',
						headers: {
							'Authorization': `Bearer ${token}`,
							'Content-Type': 'application/json'
						},
						body: JSON.stringify(requestData)
					});

					const result = await response.json();

					if (result.success) {
						// 关闭表单
						closeAddForm();

						// 显示加载状态
						showLoadingMessage('添加成功，正在刷新数据...');

						// 重新加载数据
						const data = await loadTimelineData(type === 'myPastData' ? 'myPast' : 'health');
						const containerId = type === 'myPastData' ? 'myPastContainer' : 'healthContainer';
						renderTimeline(containerId, data, {
							iconText: type === 'myPastData' ? '📅' : '🏥',
							titleField: 'title',
							timeField: 'time',
							contentField: 'content',
							imagesField: 'images',
							videosField: 'videos'
						});

						// 隐藏加载状态
						hideLoadingMessage();

						// 显示成功提示
						showSuccessMessage('添加成功！');
					} else {
						alert('添加失败: ' + result.message);
					}
				} catch (error) {
					console.error('添加失败:', error);
					alert('添加失败，请稍后重试');
				}
			}

			// 提交新更新日志版本
			async function submitNewChangelog() {
				// 防止重复提交
				const submitBtn = document.querySelector('#addChangelogForm button[type="submit"]');
				if (submitBtn) {
					submitBtn.disabled = true;
					submitBtn.textContent = '⏳ 提交中...';
				}

				try {
					const version = document.getElementById('addVersion').value.trim();
					const order = parseInt(document.getElementById('addOrder').value);

					if (!version) {
						alert('请填写版本号');
						return;
					}

					if (!order || order < 1) {
						alert('请填写有效的排序值');
						return;
					}

					const token = localStorage.getItem('token') || sessionStorage.getItem('token');
					const apiBaseUrl = window.OneLoveConfig?.apiBaseUrl || '/api';

					const requestData = {
						version: version,
						order: order
					};

					// 检查是否为开发者且选择手动设置时间
					const isDeveloper = globalUserRole === 'developer';
					// 获取当前时间（UTC+8）
					const now = new Date();
					const utc8Time = new Date(now.getTime() + (8 * 60 * 60 * 1000));
					const formattedTime = formatTimeWithSeconds(utc8Time.toISOString().slice(0, 19).replace('T', ' '));

					if (isDeveloper) {
						const versionTimeSetting = document.getElementById('versionTimeSetting');
						const versionManualTimeInput = document.getElementById('versionManualTimeInput');

						if (versionTimeSetting && versionTimeSetting.value === 'manual' && versionManualTimeInput && versionManualTimeInput.value) {
							// 开发者选择手动设置时间
							const selectedTime = new Date(versionManualTimeInput.value);
							const manualUtc8Time = new Date(selectedTime.getTime() + (8 * 60 * 60 * 1000));
							requestData.time = formatTimeWithSeconds(manualUtc8Time.toISOString().slice(0, 19).replace('T', ' '));
							requestData.useAutoTime = false;
						} else {
							// 开发者选择自动设置时间
							requestData.time = formattedTime;
							requestData.useAutoTime = true;
						}
					} else {
						// 非开发者只能使用自动时间
						requestData.time = formattedTime;
						requestData.useAutoTime = true;
					}

					const response = await fetch(`${apiBaseUrl}/changelog`, {
						method: 'POST',
						headers: {
							'Authorization': `Bearer ${token}`,
							'Content-Type': 'application/json'
						},
						body: JSON.stringify(requestData)
					});

					const result = await response.json();

					if (result.success) {
						// 显示成功提示并关闭表单
						closeAddChangelogForm();

						// 显示加载状态
						showLoadingMessage('版本添加成功，正在刷新数据...');

						// 重新加载并渲染所有数据
						await loadAllData();

						// 重新处理锚点跳转
						handleAnchorNavigation();

						// 隐藏加载状态
						hideLoadingMessage();

						// 显示成功提示
						showSuccessMessage('版本添加成功！');
					} else {
						alert('添加失败: ' + result.message);
					}
				} catch (error) {
					console.error('添加失败:', error);
					alert('添加失败，请稍后重试');
				} finally {
					// 恢复按钮状态
					const submitBtn = document.querySelector('#addChangelogForm button[type="submit"]');
					if (submitBtn) {
						submitBtn.disabled = false;
						submitBtn.textContent = '添加版本';
					}
				}
			}

			// 提交新条目
			async function submitNewChangelogItem() {
				// 防止重复提交
				const submitBtn = document.querySelector('#addChangelogItemForm button[type="submit"]');
				if (submitBtn) {
					submitBtn.disabled = true;
					submitBtn.textContent = '⏳ 提交中...';
				}

				try {
					const versionId = document.getElementById('addItemVersionId').value;
					const itemContent = document.getElementById('addChangelogItemContent').value.trim();

					if (!itemContent) {
						alert('请填写条目内容');
						return;
					}

					if (!versionId) {
						alert('版本ID无效');
						return;
					}

					const token = localStorage.getItem('token') || sessionStorage.getItem('token');
					if (!token) {
						alert('请先登录');
						return;
					}

					const apiBaseUrl = window.OneLoveConfig?.apiBaseUrl || '/api';

					// 构建请求数据
					const requestData = {
						itemContent: itemContent
					};

					// 验证请求数据格式
					console.log('请求数据验证:', {
						itemContent: typeof itemContent,
						itemContentLength: itemContent.length,
						requestData: requestData
					});

					// 获取当前时间（UTC+8）
					const now = new Date();
					const utc8Time = new Date(now.getTime() + (8 * 60 * 60 * 1000));
					const formattedTime = formatTimeWithSeconds(utc8Time.toISOString().slice(0, 19).replace('T', ' '));

					// 检查是否为开发者且选择手动设置时间
					const isDeveloper = globalUserRole === 'developer';
					if (isDeveloper) {
						const timeSetting = document.getElementById('timeSetting');
						const manualTimeInput = document.getElementById('manualTimeInput');

						if (timeSetting && timeSetting.value === 'manual' && manualTimeInput && manualTimeInput.value) {
							// 开发者选择手动设置时间
							const selectedTime = new Date(manualTimeInput.value);
							const manualUtc8Time = new Date(selectedTime.getTime() + (8 * 60 * 60 * 1000));
							requestData.itemTime = formatTimeWithSeconds(manualUtc8Time.toISOString().slice(0, 19).replace('T', ' '));
							requestData.useAutoTime = false;
						} else {
							// 开发者选择自动设置时间
							requestData.itemTime = formattedTime;
							requestData.useAutoTime = true;
						}
					} else {
						// 非开发者只能使用自动时间
						requestData.itemTime = formattedTime;
						requestData.useAutoTime = true;
					}

					// 调试信息
					console.log('发送请求数据:', {
						url: `${apiBaseUrl}/changelog/${versionId}/items`,
						requestData: requestData,
						token: token ? '存在' : '不存在',
						userRole: globalUserRole
					});

					const response = await fetch(`${apiBaseUrl}/changelog/${versionId}/items`, {
						method: 'POST',
						headers: {
							'Authorization': `Bearer ${token}`,
							'Content-Type': 'application/json'
						},
						body: JSON.stringify(requestData)
					});

					// 调试响应信息
					console.log('服务器响应:', {
						status: response.status,
						statusText: response.statusText,
						ok: response.ok
					});

					if (!response.ok) {
						const errorText = await response.text();
						console.error('服务器错误详情:', errorText);
						throw new Error(`服务器错误 (${response.status}): ${errorText}`);
					}

					const result = await response.json();

					if (result.success) {
						// 显示成功提示并关闭表单
						closeAddChangelogItemForm();

						// 重新加载并渲染全部数据，确保新条目与时间显示
						await loadAllData();

						// 重新处理锚点跳转
						handleAnchorNavigation();

						// 隐藏加载状态
						hideLoadingMessage();

						// 显示成功提示
						showSuccessMessage('条目添加成功！');
					} else {
						alert('添加失败: ' + result.message);
					}
				} catch (error) {
					console.error('添加失败:', error);
					alert('添加失败，请稍后重试');
				} finally {
					// 恢复按钮状态
					const submitBtn = document.querySelector('#addChangelogItemForm button[type="submit"]');
					if (submitBtn) {
						submitBtn.disabled = false;
						submitBtn.textContent = '添加条目';
					}
				}
			}

			/**
			 * 预览内容函数
			 * @param {string} textareaId - 文本框的ID
			 */
			function previewContent(textareaId) {
				const textarea = document.getElementById(textareaId);
				if (!textarea) {
					alert('找不到文本框');
					return;
				}

				const content = textarea.value.trim();
				if (!content) {
					alert('请先输入内容');
					return;
				}

				// 解析内容
				const parsedResult = parseContent(content);

				// 创建预览模态框
				const modalHtml = `
					<div id="previewModalOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; display: flex; justify-content: center; align-items: center;">
						<div style="background: #34495E; color: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
							<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
								<h3>内容预览 ${parsedResult.indicator}</h3>
								<button onclick="closePreviewModal()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;">×</button>
							</div>
							<div style="border: 1px solid #555; padding: 15px; border-radius: 5px; background: #2C3E50; margin-bottom: 15px;">
								<div class="parsed-content" style="color: white;">
									${parsedResult.parsedContent}
								</div>
							</div>
							<div style="text-align: center;">
								<button onclick="closePreviewModal()" style="background: #16A085; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">关闭预览</button>
							</div>
						</div>
					</div>
				`;

				document.body.insertAdjacentHTML('beforeend', modalHtml);

				// 添加ESC键关闭功能
				const overlay = document.getElementById('previewModalOverlay');
				overlay.addEventListener('keydown', function (e) {
					if (e.key === 'Escape') {
						closePreviewModal();
					}
				});
			}

			/**
			 * 显示图片模态框
			 */
			function showImageModal(imageUrl) {
				const modal = document.createElement('div');
				modal.className = 'modal-overlay';
				const modalImg = document.createElement('img');
				modalImg.src = imageUrl;
				modalImg.className = 'modal-image';
				modal.appendChild(modalImg);
				modal.onclick = () => modal.remove();
				document.body.appendChild(modal);
			}

			/**
			 * 关闭预览模态框
			 */
			function closePreviewModal() {
				const overlay = document.getElementById('previewModalOverlay');
				if (overlay) {
					overlay.remove();
				}
			}
		</script>
		</div>
	</article>

	<!-- 滚动指示器 -->
	<div class="scroll-indicator" id="scrollIndicator" onclick="scrollToTop()">
		↑
	</div>

	<footer>
		Copyright © qAiJi
		<br />
		备案是不阔能备案滴
	</footer>

	<script>
		// 滚动指示器功能
		const scrollIndicator = document.getElementById('scrollIndicator');

		// 监听滚动事件
		window.addEventListener('scroll', function () {
			const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

			// 当滚动超过300px时显示指示器
			if (scrollTop > 300) {
				scrollIndicator.classList.add('visible');
			} else {
				scrollIndicator.classList.remove('visible');
			}
		});

		// 滚动到顶部功能
		function scrollToTop() {
			window.scrollTo({
				top: 0,
				behavior: 'smooth'
			});
		}



		// 添加键盘快捷键支持
		document.addEventListener('keydown', function (e) {
			// Ctrl/Cmd + 方向键滚动
			if (e.ctrlKey || e.metaKey) {
				switch (e.key) {
					case 'ArrowUp':
						e.preventDefault();
						scrollToTop();
						break;
					case 'ArrowDown':
						e.preventDefault();
						window.scrollTo({
							top: document.body.scrollHeight,
							behavior: 'smooth'
						});
						break;
				}
			}
		});

		// 添加触摸滑动支持（移动端）
		let touchStartY = 0;
		let touchEndY = 0;

		document.addEventListener('touchstart', function (e) {
			touchStartY = e.touches[0].clientY;
		});

		document.addEventListener('touchend', function (e) {
			touchEndY = e.changedTouches[0].clientY;
			const diff = touchStartY - touchEndY;

			// 向上滑动超过50px时显示滚动指示器
			if (diff > 50 && window.pageYOffset > 300) {
				scrollIndicator.classList.add('visible');
			}
		});

		// 初始化滚动效果
		document.addEventListener('DOMContentLoaded', function () {
			// 为所有timeline添加淡入效果
			const timelineItems = document.querySelectorAll('.timeline .item');
			timelineItems.forEach((item, index) => {
				item.style.opacity = '0';
				item.style.transform = 'translateY(20px)';
				item.style.transition = 'opacity 0.5s ease, transform 0.5s ease';

				setTimeout(() => {
					item.style.opacity = '1';
					item.style.transform = 'translateY(0)';
				}, index * 100);
			});
		});
	</script>
</body>

</html>