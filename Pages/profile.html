<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人信息 - OneLove</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .profile-container {
            max-width: 800px;
            margin: 50px auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .profile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        .profile-header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 300;
        }
        
        .profile-header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .profile-body {
            padding: 40px;
        }
        
        .section {
            margin-bottom: 40px;
        }
        
        .section h3 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f8f9fa;
        }
        
        .form-floating {
            margin-bottom: 20px;
        }
        
        .form-control {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            padding: 12px 30px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            border: none;
            border-radius: 10px;
            padding: 12px 30px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .alert {
            border-radius: 10px;
            border: none;
            margin-bottom: 20px;
        }
        
        .info-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .info-item:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-weight: 500;
            color: #333;
        }
        
        .info-value {
            color: #666;
        }
        
        .edit-mode {
            display: none;
        }
        
        .view-mode {
            display: block;
        }
        
        .loading {
            display: none;
        }
        
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }
        
        .back-link {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            text-decoration: none;
            font-size: 1.1rem;
        }
        
        .back-link:hover {
            color: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="profile-container">
        <div class="profile-header">
            <a href="/" class="back-link">
                <i class="fas fa-arrow-left"></i> 返回首页
            </a>
            <h1><i class="fas fa-user"></i> 个人信息</h1>
            <p>管理您的账户信息和设置</p>
        </div>
        
        <div class="profile-body">
            <!-- 成功消息 -->
            <div class="alert alert-success" id="successAlert" style="display: none;">
                <i class="fas fa-check-circle"></i> <span id="successMessage"></span>
            </div>
            
            <!-- 错误消息 -->
            <div class="alert alert-danger" id="errorAlert" style="display: none;">
                <i class="fas fa-exclamation-circle"></i> <span id="errorMessage"></span>
            </div>
            
            <!-- 基本信息 -->
            <div class="section">
                <h3><i class="fas fa-info-circle"></i> 基本信息</h3>
                
                <!-- 查看模式 -->
                <div id="viewMode" class="view-mode">
                    <div class="info-card">
                        <div class="info-item">
                            <span class="info-label">用户名</span>
                            <span class="info-value" id="viewUsername"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">邮箱</span>
                            <span class="info-value" id="viewEmail"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">角色</span>
                            <span class="info-value" id="viewRole"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">账户状态</span>
                            <span class="info-value" id="viewStatus"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">注册时间</span>
                            <span class="info-value" id="viewCreatedAt"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">最后登录</span>
                            <span class="info-value" id="viewLastLogin"></span>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="toggleEditMode()">
                        <i class="fas fa-edit"></i> 编辑信息
                    </button>
                </div>
                
                <!-- 编辑模式 -->
                <div id="editMode" class="edit-mode">
                    <form id="profileForm">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="username" placeholder="用户名" required>
                            <label for="username">用户名</label>
                        </div>
                        
                        <div class="form-floating">
                            <input type="email" class="form-control" id="email" placeholder="邮箱" required>
                            <label for="email">邮箱</label>
                        </div>
                        
                        <div class="form-floating">
                            <input type="text" class="form-control" id="phone" placeholder="手机号码">
                            <label for="phone">手机号码</label>
                        </div>
                        
                        <div class="form-floating">
                            <textarea class="form-control" id="bio" placeholder="个人简介" style="height: 100px"></textarea>
                            <label for="bio">个人简介</label>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <span class="btn-text">保存更改</span>
                                <span class="loading">
                                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                    保存中...
                                </span>
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="cancelEdit()">
                                取消
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- 安全设置 -->
            <div class="section">
                <h3><i class="fas fa-shield-alt"></i> 安全设置</h3>
                <div class="info-card">
                    <div class="info-item">
                        <span class="info-label">修改密码</span>
                        <button class="btn btn-outline-primary btn-sm" onclick="showChangePassword()">
                            修改密码
                        </button>
                    </div>
                    <div class="info-item">
                        <span class="info-label">账户状态</span>
                        <span class="badge bg-success" id="accountStatus">活跃</span>
                    </div>
                </div>
            </div>
            
            <!-- 数据统计 -->
            <div class="section">
                <h3><i class="fas fa-chart-bar"></i> 数据统计</h3>
                <div class="row">
                    <div class="col-md-3">
                        <div class="info-card text-center">
                            <h4 id="totalData">0</h4>
                            <p class="text-muted">总数据量</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="info-card text-center">
                            <h4 id="passwordCount">0</h4>
                            <p class="text-muted">密码数据</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="info-card text-center">
                            <h4 id="phoneCount">0</h4>
                            <p class="text-muted">手机数据</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="info-card text-center">
                            <h4 id="noteCount">0</h4>
                            <p class="text-muted">笔记数据</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin + '/api';
        let currentUser = null;
        
        // 获取认证令牌
        function getAuthToken() {
            return sessionStorage.getItem('token') || localStorage.getItem('token');
        }
        
        // 显示消息
        function showMessage(type, message) {
            const successAlert = document.getElementById('successAlert');
            const errorAlert = document.getElementById('errorAlert');
            const successMessage = document.getElementById('successMessage');
            const errorMessage = document.getElementById('errorMessage');
            
            successAlert.style.display = 'none';
            errorAlert.style.display = 'none';
            
            if (type === 'success') {
                successMessage.textContent = message;
                successAlert.style.display = 'block';
            } else {
                errorMessage.textContent = message;
                errorAlert.style.display = 'block';
            }
        }
        
        // 设置加载状态
        function setLoading(loading) {
            const btn = document.querySelector('#profileForm button[type="submit"]');
            const btnText = btn.querySelector('.btn-text');
            const loadingSpan = btn.querySelector('.loading');
            
            if (loading) {
                btnText.style.display = 'none';
                loadingSpan.style.display = 'inline-block';
                btn.disabled = true;
            } else {
                btnText.style.display = 'inline-block';
                loadingSpan.style.display = 'none';
                btn.disabled = false;
            }
        }
        
        // 加载用户信息
        async function loadUserInfo() {
            try {
                const authToken = getAuthToken();
                if (!authToken) {
                    window.location.href = '/Pages/login.html';
                    return;
                }
                
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('获取用户信息失败');
                }
                
                const data = await response.json();
                currentUser = data.data.user;
                
                displayUserInfo(currentUser);
                loadUserStats();
                
            } catch (error) {
                console.error('加载用户信息失败:', error);
                showMessage('error', '加载用户信息失败');
            }
        }
        
        // 显示用户信息
        function displayUserInfo(user) {
            // 查看模式
            document.getElementById('viewUsername').textContent = user.username;
            document.getElementById('viewEmail').textContent = user.email;
            document.getElementById('viewRole').textContent = user.role === 'admin' ? '管理员' : '普通用户';
            document.getElementById('viewStatus').textContent = user.isActive ? '活跃' : '禁用';
            document.getElementById('viewCreatedAt').textContent = new Date(user.createdAt).toLocaleString('zh-CN');
            document.getElementById('viewLastLogin').textContent = user.lastLogin ? new Date(user.lastLogin).toLocaleString('zh-CN') : '从未登录';
            
            // 编辑模式
            document.getElementById('username').value = user.username;
            document.getElementById('email').value = user.email;
            document.getElementById('phone').value = user.profile?.phone || '';
            document.getElementById('bio').value = user.profile?.bio || '';
        }
        
        // 加载用户统计数据
        async function loadUserStats() {
            try {
                const authToken = getAuthToken();
                const response = await fetch(`${API_BASE}/userdata/stats`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const stats = data.data;
                    
                    document.getElementById('totalData').textContent = stats.total || 0;
                    document.getElementById('passwordCount').textContent = stats.passwords || 0;
                    document.getElementById('phoneCount').textContent = stats.phones || 0;
                    document.getElementById('noteCount').textContent = stats.notes || 0;
                }
            } catch (error) {
                console.error('加载统计数据失败:', error);
            }
        }
        
        // 切换编辑模式
        function toggleEditMode() {
            document.getElementById('viewMode').style.display = 'none';
            document.getElementById('editMode').style.display = 'block';
        }
        
        // 取消编辑
        function cancelEdit() {
            document.getElementById('viewMode').style.display = 'block';
            document.getElementById('editMode').style.display = 'none';
            displayUserInfo(currentUser); // 恢复原始数据
        }
        
        // 显示修改密码对话框
        function showChangePassword() {
            const currentPassword = prompt('请输入当前密码：');
            if (!currentPassword) return;
            
            const newPassword = prompt('请输入新密码：');
            if (!newPassword) return;
            
            const confirmPassword = prompt('请确认新密码：');
            if (newPassword !== confirmPassword) {
                alert('两次输入的密码不一致');
                return;
            }
            
            changePassword(currentPassword, newPassword);
        }
        
        // 修改密码
        async function changePassword(currentPassword, newPassword) {
            try {
                const authToken = getAuthToken();
                const response = await fetch(`${API_BASE}/auth/password`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        currentPassword,
                        newPassword
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage('success', '密码修改成功');
                } else {
                    showMessage('error', data.message || '密码修改失败');
                }
            } catch (error) {
                console.error('修改密码失败:', error);
                showMessage('error', '修改密码失败');
            }
        }
        
        // 更新个人信息
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                username: document.getElementById('username').value.trim(),
                email: document.getElementById('email').value.trim(),
                profile: {
                    phone: document.getElementById('phone').value.trim(),
                    bio: document.getElementById('bio').value.trim()
                }
            };
            
            setLoading(true);
            
            try {
                const authToken = getAuthToken();
                const response = await fetch(`${API_BASE}/auth/profile`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage('success', '个人信息更新成功');
                    currentUser = data.data.user;
                    displayUserInfo(currentUser);
                    cancelEdit();
                } else {
                    showMessage('error', data.message || '更新失败');
                }
            } catch (error) {
                console.error('更新个人信息失败:', error);
                showMessage('error', '更新失败');
            } finally {
                setLoading(false);
            }
        });
        
        // 页面加载时检查认证并加载数据
        window.addEventListener('load', () => {
            loadUserInfo();
        });
    </script>
</body>
</html> 