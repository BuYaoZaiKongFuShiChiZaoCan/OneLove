<!DOCTYPE html>
<html lang="zh-CN">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>重置密码 - OneLove</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
	<style>
		body {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
			display: flex;
			align-items: center;
			justify-content: center;
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
		}

		.reset-container {
			background: white;
			border-radius: 20px;
			box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
			overflow: hidden;
			width: 100%;
			max-width: 400px;
			margin: 20px;
		}

		.reset-header {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			padding: 30px;
			text-align: center;
		}

		.reset-header h2 {
			margin: 0;
			font-size: 2rem;
			font-weight: 300;
		}

		.reset-header p {
			margin: 10px 0 0 0;
			opacity: 0.9;
		}

		.reset-body {
			padding: 40px 30px;
		}

		.form-floating {
			margin-bottom: 20px;
		}

		.form-control {
			border-radius: 10px;
			border: 2px solid #e9ecef;
			padding: 12px 15px;
			transition: all 0.3s ease;
		}

		.form-control:focus {
			border-color: #667eea;
			box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
		}

		.btn-reset {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			border: none;
			border-radius: 10px;
			padding: 12px;
			font-size: 1.1rem;
			font-weight: 500;
			width: 100%;
			transition: all 0.3s ease;
		}

		.btn-reset:hover {
			transform: translateY(-2px);
			box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
		}

		.btn-reset:disabled {
			opacity: 0.7;
			transform: none;
		}

		.back-to-login {
			text-align: center;
			margin-top: 20px;
			padding-top: 20px;
			border-top: 1px solid #e9ecef;
		}

		.back-to-login a {
			color: #667eea;
			text-decoration: none;
			font-weight: 500;
		}

		.back-to-login a:hover {
			text-decoration: underline;
		}

		.alert {
			border-radius: 10px;
			border: none;
			margin-bottom: 20px;
		}

		.loading {
			display: none;
		}

		.spinner-border-sm {
			width: 1rem;
			height: 1rem;
		}

		.password-strength {
			margin-top: 10px;
			font-size: 0.9rem;
		}

		.strength-weak {
			color: #dc3545;
		}

		.strength-medium {
			color: #ffc107;
		}

		.strength-strong {
			color: #28a745;
		}
	</style>
</head>

<body>
	<div class="reset-container">
		<div class="reset-header">
			<h2><i class="fas fa-key"></i> 重置密码</h2>
			<p>设置您的新密码</p>
		</div>

		<div class="reset-body">
			<!-- 成功消息 -->
			<div class="alert alert-success" id="successAlert" style="display: none;">
				<i class="fas fa-check-circle"></i> <span id="successMessage"></span>
			</div>

			<!-- 错误消息 -->
			<div class="alert alert-danger" id="errorAlert" style="display: none;">
				<i class="fas fa-exclamation-circle"></i> <span id="errorMessage"></span>
			</div>

			<form id="resetForm">
				<div class="form-floating">
					<input type="password" class="form-control" id="newPassword" placeholder="新密码" required minlength="6">
					<label for="newPassword">新密码</label>
				</div>

				<div class="password-strength" id="passwordStrength"></div>

				<div class="form-floating">
					<input type="password" class="form-control" id="confirmPassword" placeholder="确认新密码" required>
					<label for="confirmPassword">确认新密码</label>
				</div>

				<button type="submit" class="btn btn-primary btn-reset" id="resetBtn">
					<span class="btn-text">重置密码</span>
					<span class="loading">
						<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
						重置中...
					</span>
				</button>
			</form>

			<div class="back-to-login">
				<p><a href="login.html"><i class="fas fa-arrow-left"></i> 返回登录</a></p>
			</div>
		</div>
	</div>

	<script>
		const API_BASE = window.location.origin;
		let resetToken = null;

		// 获取URL参数中的token
		function getTokenFromUrl() {
			const urlParams = new URLSearchParams(window.location.search);
			return urlParams.get('token');
		}

		// 显示消息函数
		function showMessage(type, message) {
			const successAlert = document.getElementById('successAlert');
			const errorAlert = document.getElementById('errorAlert');
			const successMessage = document.getElementById('successMessage');
			const errorMessage = document.getElementById('errorMessage');

			// 隐藏所有消息
			successAlert.style.display = 'none';
			errorAlert.style.display = 'none';

			if (type === 'success') {
				successMessage.textContent = message;
				successAlert.style.display = 'block';
			} else {
				errorMessage.textContent = message;
				errorAlert.style.display = 'block';
			}
		}

		// 设置加载状态
		function setLoading(loading) {
			const resetBtn = document.getElementById('resetBtn');
			const btnText = resetBtn.querySelector('.btn-text');
			const loadingSpan = resetBtn.querySelector('.loading');

			if (loading) {
				btnText.style.display = 'none';
				loadingSpan.style.display = 'inline-block';
				resetBtn.disabled = true;
			} else {
				btnText.style.display = 'inline-block';
				loadingSpan.style.display = 'none';
				resetBtn.disabled = false;
			}
		}

		// 检查密码强度
		function checkPasswordStrength(password) {
			const strengthDiv = document.getElementById('passwordStrength');
			let strength = 0;
			let message = '';
			let className = '';

			if (password.length >= 6) strength++;
			if (password.length >= 8) strength++;
			if (/[a-z]/.test(password)) strength++;
			if (/[A-Z]/.test(password)) strength++;
			if (/[0-9]/.test(password)) strength++;
			if (/[^A-Za-z0-9]/.test(password)) strength++;

			if (strength < 3) {
				message = '密码强度：弱';
				className = 'strength-weak';
			} else if (strength < 5) {
				message = '密码强度：中等';
				className = 'strength-medium';
			} else {
				message = '密码强度：强';
				className = 'strength-strong';
			}

			strengthDiv.textContent = message;
			strengthDiv.className = `password-strength ${className}`;
		}

		// 监听密码输入
		document.getElementById('newPassword').addEventListener('input', function () {
			checkPasswordStrength(this.value);
		});

		// 重置密码表单提交
		document.getElementById('resetForm').addEventListener('submit', async (e) => {
			e.preventDefault();

			const newPassword = document.getElementById('newPassword').value;
			const confirmPassword = document.getElementById('confirmPassword').value;

			// 验证输入
			if (!newPassword || !confirmPassword) {
				showMessage('error', '请填写所有字段');
				return;
			}

			if (newPassword.length < 6) {
				showMessage('error', '密码至少需要6个字符');
				return;
			}

			if (newPassword !== confirmPassword) {
				showMessage('error', '两次输入的密码不一致');
				return;
			}

			if (!resetToken) {
				showMessage('error', '重置令牌无效或已过期');
				return;
			}

			setLoading(true);

			try {
				const response = await fetch(`${API_BASE}/api/auth/reset-password`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({
						token: resetToken,
						newPassword: newPassword
					})
				});

				const data = await response.json();

				if (data.success) {
					showMessage('success', '密码重置成功！正在跳转到登录页面...');

					// 清空表单
					document.getElementById('resetForm').reset();

					// 跳转到登录页面
					setTimeout(() => {
						window.location.href = 'login.html';
					}, 2000);

				} else {
					showMessage('error', data.message || '密码重置失败');
				}

			} catch (error) {
				console.error('重置密码错误:', error);
				showMessage('error', '网络错误，请稍后重试');
			} finally {
				setLoading(false);
			}
		});

		// 页面加载时检查token
		window.addEventListener('load', () => {
			resetToken = getTokenFromUrl();

			if (!resetToken) {
				showMessage('error', '重置令牌无效或已过期，请重新申请密码重置');
				document.getElementById('resetForm').style.display = 'none';
			}
		});
	</script>
</body>

</html>