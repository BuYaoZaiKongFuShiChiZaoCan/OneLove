<!DOCTYPE html>
<html lang="zh-CN">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>密码管理 - OneLove</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
			color: #333;
		}

		.container {
			max-width: 1200px;
			margin: 0 auto;
			padding: 20px;
		}

		.header {
			background: rgba(255, 255, 255, 0.95);
			backdrop-filter: blur(10px);
			border-radius: 15px;
			padding: 20px;
			margin-bottom: 20px;
			box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.header h1 {
			color: #4a5568;
			display: flex;
			align-items: center;
			gap: 10px;
		}

		.back-btn {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			border: none;
			padding: 10px 20px;
			border-radius: 25px;
			cursor: pointer;
			font-size: 14px;
			text-decoration: none;
			display: flex;
			align-items: center;
			gap: 8px;
		}

		.back-btn:hover {
			transform: scale(1.05);
		}

		.controls {
			background: rgba(255, 255, 255, 0.95);
			backdrop-filter: blur(10px);
			border-radius: 15px;
			padding: 20px;
			margin-bottom: 20px;
			box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
			display: flex;
			gap: 15px;
			align-items: center;
			flex-wrap: wrap;
		}

		.search-box {
			flex: 1;
			min-width: 200px;
			position: relative;
		}

		.search-box input {
			width: 100%;
			padding: 12px 40px 12px 15px;
			border: 2px solid #e2e8f0;
			border-radius: 25px;
			font-size: 14px;
			transition: border-color 0.3s ease;
		}

		.search-box input:focus {
			outline: none;
			border-color: #667eea;
		}

		.search-box i {
			position: absolute;
			right: 15px;
			top: 50%;
			transform: translateY(-50%);
			color: #a0aec0;
		}

		.add-btn {
			background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
			color: white;
			border: none;
			padding: 12px 25px;
			border-radius: 25px;
			cursor: pointer;
			font-size: 14px;
			font-weight: 500;
			display: flex;
			align-items: center;
			gap: 8px;
			transition: transform 0.2s ease;
		}

		.add-btn:hover {
			transform: scale(1.05);
		}

		.passwords-list {
			display: flex;
			flex-direction: column;
			gap: 10px;
		}

		.password-item {
			background: white;
			border: 1px solid #e2e8f0;
			border-radius: 8px;
			margin-bottom: 15px;
			overflow: hidden;
			transition: all 0.3s ease;
		}

		.password-item:hover {
			transform: translateY(-2px);
			box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
			border-color: #667eea;
		}

		.password-item.expanded {
			border-color: #667eea;
		}

		.password-item.expanded .password-details {
			display: block !important;
			visibility: visible !important;
			opacity: 1 !important;
		}

		.password-header {
			padding: 15px;
			background: #f8fafc;
			border-bottom: 1px solid #e2e8f0;
			cursor: pointer;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.password-header:hover {
			background: #f1f5f9;
		}

		.password-icon {
			width: 40px;
			height: 40px;
			border-radius: 50%;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			display: flex;
			align-items: center;
			justify-content: center;
			color: white;
			font-size: 16px;
			margin-right: 15px;
			flex-shrink: 0;
		}

		.password-info {
			flex: 1;
			min-width: 0;
		}

		.password-title {
			font-weight: 600;
			color: #1e293b;
			margin: 0;
		}

		.password-subtitle {
			font-size: 0.875rem;
			color: #64748b;
			margin: 5px 0 0 0;
		}

		.password-actions {
			display: flex;
			gap: 8px;
		}

		.action-btn {
			background: none;
			border: none;
			padding: 8px;
			border-radius: 50%;
			cursor: pointer;
			transition: all 0.2s ease;
			color: #718096;
			font-size: 14px;
		}

		.action-btn:hover {
			background-color: #f7fafc;
			color: #667eea;
		}

		.action-btn.delete:hover {
			background-color: #fed7d7;
			color: #e53e3e;
		}

		.action-btn.edit:hover {
			background-color: #e6fffa;
			color: #38b2ac;
		}

		.expand-icon {
			transition: transform 0.3s ease;
		}

		.password-item.expanded .expand-icon {
			transform: rotate(180deg);
		}

		.password-details {
			padding: 20px;
			display: none;
			transition: all 0.3s ease;
			overflow: hidden;
		}

		.password-item.expanded .password-details {
			display: block !important;
		}

		.password-details.show {
			display: block !important;
		}

		.detail-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 15px;
			margin-bottom: 20px;
		}

		.detail-item {
			background: #f8fafc;
			padding: 12px;
			border-radius: 6px;
			border-left: 3px solid #3b82f6;
		}

		.detail-label {
			font-weight: 600;
			color: #374151;
			font-size: 0.875rem;
			margin-bottom: 5px;
		}

		.detail-value {
			color: #1f2937;
			word-break: break-all;
		}

		.detail-value:empty::after,
		.detail-value:contains("(空)") {
			color: #9ca3af;
			font-style: italic;
		}

		.detail-content {
			margin-top: 8px;
		}

		.detail-row {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 4px 0;
			border-bottom: 1px solid #f1f5f9;
		}

		.detail-row:last-child {
			border-bottom: none;
		}

		.detail-prop {
			font-weight: 600;
			color: #6b7280;
			min-width: 80px;
			margin-right: 10px;
		}

		.account-edit-section {
			border: 1px solid #e5e7eb;
			border-radius: 6px;
			padding: 15px;
			margin-bottom: 15px;
			background: #f9fafb;
		}

		.account-edit-section h5 {
			margin: 0 0 10px 0;
			color: #374151;
			font-size: 14px;
			font-weight: 600;
		}

		.properties-edit {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 10px;
		}

		.property-edit-item {
			display: flex;
			flex-direction: column;
		}

		.property-edit-item label {
			font-size: 12px;
			color: #6b7280;
			margin-bottom: 4px;
			font-weight: 500;
		}

		.property-edit-item input {
			padding: 6px 8px;
			border: 1px solid #d1d5db;
			border-radius: 4px;
			font-size: 13px;
		}

		.form-actions {
			display: flex;
			gap: 10px;
			justify-content: flex-end;
			margin-top: 20px;
			padding-top: 15px;
			border-top: 1px solid #e5e7eb;
		}

		.empty-state {
			text-align: center;
			padding: 60px 20px;
			color: #6b7280;
		}

		.empty-state i {
			font-size: 48px;
			margin-bottom: 16px;
			color: #d1d5db;
		}

		.empty-state p {
			font-size: 16px;
			margin: 0;
		}

		.error {
			text-align: center;
			padding: 40px 20px;
			color: #dc2626;
			background: #fef2f2;
			border: 1px solid #fecaca;
			border-radius: 8px;
			margin: 20px 0;
		}

		.error i {
			font-size: 24px;
			margin-bottom: 12px;
			display: block;
		}

		.edit-form {
			background: #f8fafc;
			padding: 20px;
			border-radius: 8px;
			margin-top: 15px;
		}

		.form-group {
			margin-bottom: 15px;
		}

		.form-group.full-width {
			grid-column: 1 / -1;
		}

		.form-group label {
			display: block;
			margin-bottom: 5px;
			font-weight: 600;
			color: #374151;
		}

		.form-group input,
		.form-group select,
		.form-group textarea {
			width: 100%;
			padding: 8px 12px;
			border: 1px solid #d1d5db;
			border-radius: 4px;
			font-size: 14px;
		}

		.form-group input:focus,
		.form-group select:focus,
		.form-group textarea:focus {
			outline: none;
			border-color: #3b82f6;
			box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
		}

		.btn {
			padding: 8px 16px;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 14px;
			transition: all 0.2s;
			display: inline-flex;
			align-items: center;
			gap: 5px;
		}

		.btn-primary {
			background: #3b82f6;
			color: white;
		}

		.btn-primary:hover {
			background: #2563eb;
		}

		.btn-secondary {
			background: #6b7280;
			color: white;
		}

		.btn-secondary:hover {
			background: #4b5563;
		}

		.btn-danger {
			background: #ef4444;
			color: white;
		}

		.btn-danger:hover {
			background: #dc2626;
		}

		.btn-outline {
			background: transparent;
			border: 1px solid #d1d5db;
			color: #374151;
		}

		.btn-outline:hover {
			background: #f9fafb;
		}

		.btn-sm {
			padding: 4px 8px;
			font-size: 12px;
		}

		.new-password-item {
			background: white;
			border: 2px dashed #d1d5db;
			border-radius: 8px;
			padding: 20px;
			margin-bottom: 20px;
		}

		.new-password-form {
			display: grid;
			grid-template-columns: 1fr;
			gap: 15px;
		}

		.properties-section {
			border: 1px solid #e5e7eb;
			border-radius: 6px;
			padding: 15px;
		}

		.properties-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 15px;
			padding-bottom: 10px;
			border-bottom: 1px solid #e5e7eb;
		}

		.properties-header h4 {
			margin: 0;
			color: #374151;
		}

		.template-buttons {
			display: flex;
			gap: 8px;
		}

		.property-item {
			border: 1px solid #e5e7eb;
			border-radius: 6px;
			margin-bottom: 10px;
			overflow: hidden;
		}

		.property-header {
			background: #f9fafb;
			padding: 10px;
			display: flex;
			gap: 8px;
			align-items: center;
			border-bottom: 1px solid #e5e7eb;
		}

		.property-name {
			flex: 1;
			min-width: 120px;
		}

		.property-type {
			min-width: 100px;
		}

		.property-content {
			padding: 10px;
			display: flex;
			gap: 8px;
			align-items: flex-start;
		}

		.property-value {
			flex: 1;
		}

		.generate-btn {
			background: #10b981;
			color: white;
			border: none;
			padding: 6px 10px;
			border-radius: 4px;
			cursor: pointer;
			font-size: 12px;
		}

		.generate-btn:hover {
			background: #059669;
		}

		.modal-overlay {
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: rgba(0, 0, 0, 0.5);
			display: flex;
			align-items: center;
			justify-content: center;
			z-index: 1000;
		}

		.modal-content {
			background: white;
			border-radius: 8px;
			box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
			width: 90%;
			max-width: 800px;
		}

		.modal-header {
			padding: 20px;
			border-bottom: 1px solid #e5e7eb;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.modal-header h3 {
			margin: 0;
			color: #1f2937;
		}

		.close-btn {
			background: none;
			border: none;
			font-size: 18px;
			cursor: pointer;
			color: #6b7280;
			padding: 5px;
		}

		.close-btn:hover {
			color: #374151;
		}

		.modal-body {
			padding: 20px;
		}

		.template-sections {
			display: flex;
			flex-direction: column;
			gap: 25px;
		}

		.template-section h4 {
			margin: 0 0 15px 0;
			color: #374151;
			font-size: 16px;
		}

		.template-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
			gap: 12px;
		}

		.template-item {
			border: 1px solid #e5e7eb;
			border-radius: 6px;
			padding: 12px;
			cursor: pointer;
			transition: all 0.2s;
			background: #f9fafb;
		}

		.template-item:hover {
			border-color: #3b82f6;
			background: #eff6ff;
			transform: translateY(-2px);
			box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
		}

		.template-name {
			font-weight: 600;
			color: #1f2937;
			margin-bottom: 4px;
			font-size: 14px;
		}

		.template-type {
			font-size: 12px;
			color: #6b7280;
			margin-bottom: 4px;
		}

		.template-desc {
			font-size: 12px;
			color: #374151;
			margin-bottom: 4px;
			line-height: 1.3;
		}

		.template-weight {
			font-size: 11px;
			color: #9ca3af;
			font-weight: 500;
		}

		@media (max-width: 768px) {
			.container {
				padding: 10px;
			}

			.controls {
				flex-direction: column;
				align-items: stretch;
			}

			.new-password-form {
				grid-template-columns: 1fr;
			}

			.detail-row {
				flex-direction: column;
				align-items: stretch;
			}

			.detail-label {
				width: auto;
				margin-bottom: 5px;
			}

			.account-card-content {
				grid-template-columns: 1fr;
			}

			.accounts-header {
				flex-direction: column;
				align-items: stretch;
				gap: 10px;
			}

			.template-grid {
				grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
			}

			.property-header {
				flex-direction: column;
				gap: 8px;
			}

			.property-name,
			.property-type {
				width: 100%;
			}

			.modal-content {
				width: 95%;
				margin: 10px;
			}
		}
	</style>
</head>

<body>
	<div class="container">
		<!-- 头部 -->
		<div class="header">
			<h1>
				<i class="fas fa-key"></i>
				密码管理
			</h1>
			<a href="/Pages/admin/dashboard.html" class="back-btn">
				<i class="fas fa-arrow-left"></i>
				返回仪表板
			</a>
		</div>

		<!-- 控制栏 -->
		<div class="controls">
			<div class="search-box">
				<input type="text" id="searchInput" placeholder="搜索密码...">
				<i class="fas fa-search"></i>
			</div>
			<button class="add-btn" onclick="showNewPasswordForm()">
				<i class="fas fa-plus"></i>
				添加密码
			</button>
		</div>

		<!-- 密码列表 -->
		<div id="passwordsContainer">
			<div class="loading">
				<i class="fas fa-spinner fa-spin"></i>
				加载密码数据...
			</div>
		</div>
	</div>

	<script>
		const API_BASE = window.location.origin + '/api';
		let passwordsData = [];
		let editingId = null;

		// 获取认证令牌的函数
		function getAuthToken() {
			return sessionStorage.getItem('token');
		}

		// 检查登录状态
		async function checkAuth() {
			const authToken = getAuthToken();

			if (!authToken) {
				return false;
			}

			try {
				const response = await fetch(`${API_BASE}/auth/me`, {
					headers: {
						'Authorization': `Bearer ${authToken}`
					}
				});

				if (!response.ok) {
					sessionStorage.removeItem('token');
					return false;
				}

				return true;
			} catch (error) {
				console.error('认证检查失败:', error);
				return false;
			}
		}

		// 加载密码数据
		async function loadPasswords() {
			try {
				const authToken = getAuthToken();
				const response = await fetch(`${API_BASE}/userdata/passwords`, {
					headers: {
						'Authorization': `Bearer ${authToken}`
					}
				});

				if (!response.ok) {
					throw new Error('获取密码数据失败');
				}

				const data = await response.json();

				// 打印返回的密码数据
				console.log('返回的密码数据:', data);

				// 检查API返回的数据结构
				if (data.success && data.data) {
					passwordsData = data.data;
					renderPasswords(passwordsData);
				} else if (data.success && !data.data) {
					// API成功但无数据
					passwordsData = {};
					renderPasswords(passwordsData);
				} else {
					throw new Error(data.message || '获取数据失败');
				}
			} catch (error) {
				console.error('加载密码数据失败:', error);
				document.getElementById('passwordsContainer').innerHTML = `
                    <div class="error">
                        <i class="fas fa-exclamation-triangle"></i>
                        加载密码数据失败: ${error.message}
                    </div>
                `;
			}
		}

		// 渲染密码列表
		function renderPasswords(passwords) {
			const container = document.getElementById('passwordsContainer');
			container.innerHTML = '';

			// 检查passwords是否为空或无效
			if (!passwords || typeof passwords !== 'object') {
				container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>暂无密码数据</p>
                    </div>
                `;
				return;
			}

			Object.keys(passwords).forEach(category => {
				const categoryData = passwords[category];

				// 使用兼容系统分析数据结构
				const structure = DataCompatibilitySystem.analyzeDataStructure(categoryData);
				const normalizedAccounts = DataCompatibilitySystem.normalizeData(categoryData);

				if (normalizedAccounts.length === 0) return;

				const passwordItem = document.createElement('div');
				passwordItem.className = 'password-item';

				// 获取第一个账户的信息用于显示
				const firstAccount = normalizedAccounts[0];
				const username = DataCompatibilitySystem.getAccountDisplayName(firstAccount);

				passwordItem.innerHTML = `
                    <div class="password-header" onclick="togglePasswordDetails(this)">
                        <div class="password-icon">
                            <i class="fas fa-key"></i>
                        </div>
                        <div class="password-info">
                            <h3 class="password-title">${category}</h3>
                            <p class="password-subtitle">${username} • ${normalizedAccounts.length} 个账户</p>
                        </div>
                        <div class="password-actions">
                            <button class="action-btn edit" onclick="editPassword('${category}', event)" title="编辑">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" onclick="deletePassword('${category}', event)" title="删除">
                                <i class="fas fa-trash"></i>
                            </button>
                            <i class="fas fa-chevron-down expand-icon"></i>
                        </div>
                    </div>
                    <div class="password-details">
                        <div class="detail-grid">
                            ${renderAccountDetails(category, categoryData, structure.type)}
                        </div>
                        <div class="edit-form" id="editForm_${category}" style="display: none;">
                            ${renderEditForm(category, categoryData, structure.type)}
                        </div>
                    </div>
                `;

				container.appendChild(passwordItem);
			});
		}

		// 渲染账户详情
		function renderAccountDetails(category, categoryData, dataType) {
			const normalizedAccounts = DataCompatibilitySystem.normalizeData(categoryData);
			let details = '';

			normalizedAccounts.forEach(account => {
				details += renderSingleAccountDetails(account, category);
			});

			return details;
		}

		// 渲染单个账户详情
		function renderSingleAccountDetails(account, category) {
			let details = `<div class="detail-item">
                <div class="detail-label">账户 ${account.key}</div>
                <div class="detail-content">`;

			// 遍历账户的所有属性，包括空值
			DataCompatibilitySystem.getAccountProperties(account).forEach(prop => {
				const value = prop.value;
				// 显示所有属性，包括null、undefined和空字符串
				details += `
                    <div class="detail-row">
                        <span class="detail-prop">${prop.key}:</span>
                        <span class="detail-value">${value !== null && value !== undefined ? value : '(空)'}</span>
                    </div>
                `;
			});

			details += `</div></div>`;
			return details;
		}

		// 渲染编辑表单
		function renderEditForm(category, categoryData, dataType) {
			const normalizedAccounts = DataCompatibilitySystem.normalizeData(categoryData);

			let form = `
                <h4>编辑 ${category}</h4>
                <div class="accounts-container">
            `;

			normalizedAccounts.forEach(account => {
				form += renderAccountEditForm(account, category, dataType);
			});

			form += `
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="cancelEdit('${category}')">取消</button>
                    <button type="button" class="btn btn-primary" onclick="savePassword('${category}')">保存</button>
                </div>
            `;

			return form;
		}

		// 渲染账户编辑表单
		function renderAccountEditForm(account, category, dataType) {
			let form = `
                <div class="account-edit-section">
                    <h5>账户 ${account.key}</h5>
                    <div class="properties-edit">
            `;

			// 遍历账户的所有属性，包括空值
			DataCompatibilitySystem.getAccountProperties(account).forEach((prop, propIndex) => {
				const value = prop.value;
				form += `
                    <div class="property-edit-item">
                        <label>${prop.key}:</label>
                        <input type="text" 
                               name="edit_${category}_${account.key}_${prop.key}" 
                               value="${value !== null && value !== undefined ? value : ''}" 
                               placeholder="${prop.key}">
                    </div>
                `;
			});

			form += `
                    </div>
                </div>
            `;

			return form;
		}

		// 切换密码显示
		function togglePasswordDetails(header) {
			const passwordItem = header.closest('.password-item');
			const details = header.nextElementSibling;
			const icon = header.querySelector('.expand-icon');

			// 检查元素是否存在
			if (!details || !icon || !passwordItem) {
				console.error('找不到必要的DOM元素');
				return;
			}

			const isExpanded = passwordItem.classList.contains('expanded');
			console.log('当前展开状态:', isExpanded); // 调试信息

			if (isExpanded) {
				// 收起
				details.style.display = 'none';
				details.classList.remove('show');
				icon.className = 'fas fa-chevron-down expand-icon';
				passwordItem.classList.remove('expanded');
				console.log('已收起详情');
			} else {
				// 展开
				details.style.display = 'block';
				details.classList.add('show');
				icon.className = 'fas fa-chevron-up expand-icon';
				passwordItem.classList.add('expanded');
				console.log('已展开详情');
			}
		}

		// 开始编辑
		function editPassword(category, event) {
			event.stopPropagation(); // 阻止header的点击事件

			// 找到对应的密码项
			const passwordItem = event.target.closest('.password-item');
			if (!passwordItem) {
				console.error('找不到密码项元素');
				return;
			}

			// 强制展开详情
			const details = passwordItem.querySelector('.password-details');
			const icon = passwordItem.querySelector('.expand-icon');
			if (details && icon) {
				// 确保展开
				passwordItem.classList.add('expanded');
				details.style.display = 'block';
				details.classList.add('show');
				icon.className = 'fas fa-chevron-up expand-icon';
				console.log('已展开详情:', details.style.display); // 调试信息
			}

			const editForm = document.getElementById(`editForm_${category}`);
			if (!editForm) {
				console.error(`找不到编辑表单: editForm_${category}`);
				return;
			}

			// 获取当前数据
			const categoryData = passwordsData[category];
			if (!categoryData) {
				console.error(`找不到分类数据: ${category}`);
				return;
			}

			// 重新渲染表单
			editForm.innerHTML = renderEditForm(category, categoryData, DataCompatibilitySystem.analyzeDataStructure(categoryData).type);

			// 显示编辑表单，隐藏详情
			editForm.style.display = 'block';
			if (details) {
				details.style.display = 'none';
			}
		}

		// 取消编辑
		function cancelEdit(category) {
			const editForm = document.getElementById(`editForm_${category}`);
			if (!editForm) {
				console.error(`找不到编辑表单: editForm_${category}`);
				return;
			}

			// 找到对应的密码项
			const passwordItem = editForm.closest('.password-item');
			if (!passwordItem) {
				console.error('找不到密码项元素');
				return;
			}

			const details = passwordItem.querySelector('.password-details');
			if (!details) {
				console.error('找不到详情元素');
				return;
			}

			// 切换显示
			editForm.style.display = 'none';
			details.style.display = 'block';
		}

		// 保存密码
		async function savePassword(category) {
			const editForm = document.getElementById(`editForm_${category}`);
			if (!editForm) {
				console.error(`找不到编辑表单: editForm_${category}`);
				return;
			}

			let formData;
			try {
				formData = new FormData(editForm);
			} catch (error) {
				console.error('FormData构造失败:', error);
				return;
			}

			const accountData = {};
			for (const [key, value] of formData.entries()) {
				if (key.startsWith('edit_')) {
					const parts = key.split('_');
					const categoryName = parts[2];
					const accountIndex = parts[3];
					const fieldName = parts.slice(4).join('_');

					if (categoryName === category) {
						if (!accountData[accountIndex]) {
							accountData[accountIndex] = {};
						}
						accountData[accountIndex][fieldName] = value;
					}
				}
			}

			// 确保accountData是数组，即使只有一个账户
			if (Object.keys(accountData).length === 0) {
				accountData[0] = {}; // 如果没有账户，则添加一个空的
			}

			const passwordData = {
				category: category,
				data: DataCompatibilitySystem.mergeData(passwordsData[category], accountData)
			};

			try {
				const authToken = getAuthToken();
				const response = await fetch(`${API_BASE}/userdata/passwords/${category}`, { // 使用category作为ID
					method: 'PUT',
					headers: {
						'Content-Type': 'application/json',
						'Authorization': `Bearer ${authToken}`
					},
					body: JSON.stringify(passwordData)
				});

				if (!response.ok) {
					throw new Error('保存失败');
				}

				// 更新本地数据
				const index = passwordsData.findIndex(p => p.category === category);
				if (index !== -1) {
					passwordsData[index] = { ...passwordsData[index], ...passwordData };
				}

				// 重新渲染列表
				renderPasswords(passwordsData);

				// 找到对应的密码项并展开显示
				const passwordItems = document.querySelectorAll('.password-item');
				passwordItems.forEach(item => {
					const title = item.querySelector('.password-title');
					if (title && title.textContent === category) {
						const details = item.querySelector('.password-details');
						const icon = item.querySelector('.expand-icon');
						if (details && icon) {
							details.style.display = 'block';
							icon.className = 'fas fa-chevron-up expand-icon';
							item.classList.add('expanded');
						}
					}
				});

				// 显示成功消息
				showToast('保存成功！', 'success');
			} catch (error) {
				console.error('保存密码失败:', error);
				showToast('保存失败: ' + error.message, 'error');
			}
		}

		// 删除密码
		async function deletePassword(category, event) {
			event.stopPropagation(); // 阻止header的点击事件
			if (!confirm('确定要删除这个密码吗？')) {
				return;
			}

			try {
				const authToken = getAuthToken();
				const response = await fetch(`${API_BASE}/userdata/passwords/${category}`, { // 使用category作为ID
					method: 'DELETE',
					headers: {
						'Authorization': `Bearer ${authToken}`
					}
				});

				if (!response.ok) {
					throw new Error('删除失败');
				}

				// 从本地数据中移除
				passwordsData = passwordsData.filter(p => p.category !== category);
				renderPasswords(passwordsData);

				showToast('删除成功！', 'success');
			} catch (error) {
				console.error('删除密码失败:', error);
				showToast('删除失败: ' + error.message, 'error');
			}
		}

		// 显示新密码表单
		function showNewPasswordForm() {
			const container = document.getElementById('passwordsContainer');

			const newForm = `
                <div class="new-password-item">
                    <h3 style="margin-bottom: 15px; color: #4a5568;">
                        <i class="fas fa-plus"></i> 添加新密码
                    </h3>
                    <form onsubmit="addNewPassword(event); return false;">
                        <div class="new-password-form">
                            <div class="form-group full-width">
                                <label for="newCategory">应用名称 *</label>
                                <input type="text" id="newCategory" name="category" required placeholder="例如：x.com、微信、支付宝等">
                            </div>
                            
                            <div class="properties-section">
                                <div class="properties-header">
                                    <h4>账户属性</h4>
                                    <div class="template-buttons">
                                        <button type="button" class="btn btn-outline" onclick="addProperty()">
                                            <i class="fas fa-plus"></i> 添加属性
                                        </button>
                                        <button type="button" class="btn btn-outline" onclick="showTemplates()">
                                            <i class="fas fa-list"></i> 选择模板
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="propertiesList">
                                    <div class="property-item" data-property-index="0">
                                        <div class="property-header">
                                            <input type="text" name="property_0_name" value="status" placeholder="属性名" class="property-name">
                                            <select name="property_0_type" class="property-type" onchange="updatePropertyType(this)">
                                                <option value="text">文本</option>
                                                <option value="select" selected>选择</option>
                                                <option value="password">密码</option>
                                                <option value="email">邮箱</option>
                                                <option value="phone">手机号</option>
                                                <option value="textarea">多行文本</option>
                                            </select>
                                            <button type="button" class="btn btn-danger btn-sm" onclick="removeProperty(0)" title="删除属性">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <div class="property-content">
                                            <select name="property_0_value" class="property-value">
                                                <option value="active">active</option>
                                                <option value="inactive">inactive</option>
                                                <option value="pending">pending</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="property-item" data-property-index="1">
                                        <div class="property-header">
                                            <input type="text" name="property_1_name" value="weight" placeholder="属性名" class="property-name">
                                            <select name="property_1_type" class="property-type" onchange="updatePropertyType(this)">
                                                <option value="text" selected>文本</option>
                                                <option value="select">选择</option>
                                                <option value="password">密码</option>
                                                <option value="email">邮箱</option>
                                                <option value="phone">手机号</option>
                                                <option value="textarea">多行文本</option>
                                            </select>
                                            <button type="button" class="btn btn-danger btn-sm" onclick="removeProperty(1)" title="删除属性">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <div class="property-content">
                                            <input type="text" name="property_1_value" placeholder="属性值" class="property-value">
                                        </div>
                                    </div>
                                    
                                    <div class="property-item" data-property-index="2">
                                        <div class="property-header">
                                            <input type="text" name="property_2_name" value="email" placeholder="属性名" class="property-name">
                                            <select name="property_2_type" class="property-type" onchange="updatePropertyType(this)">
                                                <option value="text">文本</option>
                                                <option value="select">选择</option>
                                                <option value="password">密码</option>
                                                <option value="email" selected>邮箱</option>
                                                <option value="phone">手机号</option>
                                                <option value="textarea">多行文本</option>
                                            </select>
                                            <button type="button" class="btn btn-danger btn-sm" onclick="removeProperty(2)" title="删除属性">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <div class="property-content">
                                            <input type="email" name="property_2_value" placeholder="属性值" class="property-value">
                                        </div>
                                    </div>
                                    
                                    <div class="property-item" data-property-index="3">
                                        <div class="property-header">
                                            <input type="text" name="property_3_name" value="userId" placeholder="属性名" class="property-name">
                                            <select name="property_3_type" class="property-type" onchange="updatePropertyType(this)">
                                                <option value="text" selected>文本</option>
                                                <option value="select">选择</option>
                                                <option value="password">密码</option>
                                                <option value="email">邮箱</option>
                                                <option value="phone">手机号</option>
                                                <option value="textarea">多行文本</option>
                                            </select>
                                            <button type="button" class="btn btn-danger btn-sm" onclick="removeProperty(3)" title="删除属性">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <div class="property-content">
                                            <input type="text" name="property_3_value" placeholder="属性值" class="property-value">
                                        </div>
                                    </div>
                                    
                                    <div class="property-item" data-property-index="4">
                                        <div class="property-header">
                                            <input type="text" name="property_4_name" value="username" placeholder="属性名" class="property-name">
                                            <select name="property_4_type" class="property-type" onchange="updatePropertyType(this)">
                                                <option value="text" selected>文本</option>
                                                <option value="select">选择</option>
                                                <option value="password">密码</option>
                                                <option value="email">邮箱</option>
                                                <option value="phone">手机号</option>
                                                <option value="textarea">多行文本</option>
                                            </select>
                                            <button type="button" class="btn btn-danger btn-sm" onclick="removeProperty(4)" title="删除属性">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <div class="property-content">
                                            <input type="text" name="property_4_value" placeholder="属性值" class="property-value">
                                        </div>
                                    </div>
                                    
                                    <div class="property-item" data-property-index="5">
                                        <div class="property-header">
                                            <input type="text" name="property_5_name" value="password" placeholder="属性名" class="property-name">
                                            <select name="property_5_type" class="property-type" onchange="updatePropertyType(this)">
                                                <option value="text">文本</option>
                                                <option value="select">选择</option>
                                                <option value="password" selected>密码</option>
                                                <option value="email">邮箱</option>
                                                <option value="phone">手机号</option>
                                                <option value="textarea">多行文本</option>
                                            </select>
                                            <button type="button" class="btn btn-danger btn-sm" onclick="removeProperty(5)" title="删除属性">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <div class="property-content">
                                            <input type="text" name="property_5_value" placeholder="属性值" class="property-value">
                                            <button type="button" class="generate-btn" onclick="generatePassword(this)">
                                                <i class="fas fa-magic"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="property-item" data-property-index="6">
                                        <div class="property-header">
                                            <input type="text" name="property_6_name" value="avatarDescription" placeholder="属性名" class="property-name">
                                            <select name="property_6_type" class="property-type" onchange="updatePropertyType(this)">
                                                <option value="text">文本</option>
                                                <option value="select">选择</option>
                                                <option value="password">密码</option>
                                                <option value="email">邮箱</option>
                                                <option value="phone">手机号</option>
                                                <option value="textarea" selected>多行文本</option>
                                            </select>
                                            <button type="button" class="btn btn-danger btn-sm" onclick="removeProperty(6)" title="删除属性">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <div class="property-content">
                                            <textarea name="property_6_value" placeholder="属性值" class="property-value" rows="3"></textarea>
                                        </div>
                                    </div>
                                    
                                    <div class="property-item" data-property-index="7">
                                        <div class="property-header">
                                            <input type="text" name="property_7_name" value="description" placeholder="属性名" class="property-name">
                                            <select name="property_7_type" class="property-type" onchange="updatePropertyType(this)">
                                                <option value="text">文本</option>
                                                <option value="select">选择</option>
                                                <option value="password">密码</option>
                                                <option value="email">邮箱</option>
                                                <option value="phone">手机号</option>
                                                <option value="textarea" selected>多行文本</option>
                                            </select>
                                            <button type="button" class="btn btn-danger btn-sm" onclick="removeProperty(7)" title="删除属性">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <div class="property-content">
                                            <textarea name="property_7_value" placeholder="属性值" class="property-value" rows="3"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                            <button type="button" class="btn btn-secondary" onclick="hideNewPasswordForm(); return false;">
                                <i class="fas fa-times"></i> 取消
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plus"></i> 添加
                            </button>
                        </div>
                    </form>
                </div>
            `;

			container.insertAdjacentHTML('afterbegin', newForm);
		}

		// 生成属性模板
		function generatePropertyTemplates() {
			const templates = {
				'username': { count: 0, type: 'text', label: '用户名' },
				'password': { count: 0, type: 'password', label: '密码' },
				'email': { count: 0, type: 'email', label: '邮箱' },
				'phone': { count: 0, type: 'phone', label: '手机号' },
				'status': { count: 0, type: 'select', label: '状态', options: ['active', 'inactive', 'pending'] },
				'weight': { count: 0, type: 'text', label: '权重' },
				'role': { count: 0, type: 'select', label: '角色', options: ['user', 'admin', 'guest'] },
				'avatarDescription': { count: 0, type: 'textarea', label: '头像描述' },
				'loginMethod': { count: 0, type: 'select', label: '登录方式', options: ['password', 'gesture', 'fingerprint', 'face'] },
				'notes': { count: 0, type: 'textarea', label: '备注' },
				'userId': { count: 0, type: 'text', label: '用户ID' },
				'accountType': { count: 0, type: 'select', label: '账户类型', options: ['personal', 'business', 'temporary'] },
				'securityLevel': { count: 0, type: 'select', label: '安全等级', options: ['low', 'medium', 'high', 'critical'] },
				'lastLogin': { count: 0, type: 'text', label: '最后登录' },
				'createdAt': { count: 0, type: 'text', label: '创建时间' },
				'website': { count: 0, type: 'url', label: '网站地址' },
				'apiKey': { count: 0, type: 'password', label: 'API密钥' },
				'secretKey': { count: 0, type: 'password', label: '密钥' },
				'token': { count: 0, type: 'password', label: '令牌' },
				'backupEmail': { count: 0, type: 'email', label: '备用邮箱' },
				'recoveryPhone': { count: 0, type: 'phone', label: '恢复手机' }
			};

			// 分析现有数据，更新使用频率
			passwordsData.forEach(password => {
				const data = password.data || {};
				if (Array.isArray(data)) {
					data.forEach(account => {
						Object.keys(account).forEach(key => {
							if (templates[key]) {
								templates[key].count++;
							}
						});
					});
				}
			});

			return templates;
		}

		// 添加属性
		function addProperty() {
			const propertiesList = document.getElementById('propertiesList');
			const currentProperties = propertiesList.querySelectorAll('.property-item');
			const newIndex = currentProperties.length;

			const newPropertyHtml = `
                <div class="property-item" data-property-index="${newIndex}">
                    <div class="property-header">
                        <input type="text" name="property_${newIndex}_name" placeholder="属性名" class="property-name">
                        <select name="property_${newIndex}_type" class="property-type" onchange="updatePropertyType(this)">
                            <option value="text">文本</option>
                            <option value="password">密码</option>
                            <option value="email">邮箱</option>
                            <option value="phone">手机号</option>
                            <option value="select">选择</option>
                            <option value="textarea">多行文本</option>
                        </select>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeProperty(${newIndex})" title="删除属性">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="property-content">
                        <input type="text" name="property_${newIndex}_value" placeholder="属性值" class="property-value">
                        <button type="button" class="generate-btn" onclick="generatePassword(this)" style="display: none;">
                            <i class="fas fa-magic"></i>
                        </button>
                    </div>
                </div>
            `;

			propertiesList.insertAdjacentHTML('beforeend', newPropertyHtml);
			renumberProperties();
		}

		// 删除属性
		function removeProperty(index) {
			const propertyItem = document.querySelector(`[data-property-index="${index}"]`);
			if (propertyItem) {
				propertyItem.remove();
				renumberProperties();
			}
		}

		// 重新编号属性
		function renumberProperties() {
			const propertyItems = document.querySelectorAll('.property-item');
			propertyItems.forEach((item, newIndex) => {
				item.setAttribute('data-property-index', newIndex);

				// 更新所有输入框的name属性
				const inputs = item.querySelectorAll('input, select');
				inputs.forEach(input => {
					const oldName = input.name;
					if (oldName.startsWith('property_')) {
						const parts = oldName.split('_');
						const fieldType = parts[2];
						input.name = `property_${newIndex}_${fieldType}`;
					}
				});

				// 更新删除按钮的onclick
				const deleteBtn = item.querySelector('.btn-danger');
				if (deleteBtn) {
					deleteBtn.setAttribute('onclick', `removeProperty(${newIndex})`);
				}
			});
		}

		// 更新属性类型
		function updatePropertyType(select) {
			const propertyItem = select.closest('.property-item');
			const generateBtn = propertyItem.querySelector('.generate-btn');
			const valueInput = propertyItem.querySelector('.property-value');
			const propertyName = propertyItem.querySelector('.property-name').value;

			// 隐藏生成按钮
			generateBtn.style.display = 'none';

			// 根据类型更新输入框
			if (select.value === 'password') {
				generateBtn.style.display = 'inline-block';
				valueInput.outerHTML = `<input type="text" name="${valueInput.name}" placeholder="属性值" class="property-value">`;
			} else if (select.value === 'textarea') {
				valueInput.outerHTML = `<textarea name="${valueInput.name}" placeholder="属性值" class="property-value" rows="3"></textarea>`;
			} else if (select.value === 'select') {
				// 根据属性名提供不同的选项
				let options = ['选项1', '选项2', '选项3'];
				if (propertyName.toLowerCase().includes('status')) {
					options = ['active', 'inactive', 'pending'];
				} else if (propertyName.toLowerCase().includes('role')) {
					options = ['user', 'admin', 'guest'];
				} else if (propertyName.toLowerCase().includes('login')) {
					options = ['password', 'gesture', 'fingerprint', 'face'];
				} else if (propertyName.toLowerCase().includes('type')) {
					options = ['personal', 'business', 'temporary'];
				} else if (propertyName.toLowerCase().includes('security')) {
					options = ['low', 'medium', 'high', 'critical'];
				}

				let selectHtml = `<select name="${valueInput.name}" class="property-value">`;
				options.forEach(option => {
					selectHtml += `<option value="${option}">${option}</option>`;
				});
				selectHtml += '</select>';
				valueInput.outerHTML = selectHtml;
			} else {
				const inputType = select.value;
				valueInput.outerHTML = `<input type="${inputType}" name="${valueInput.name}" placeholder="属性值" class="property-value">`;
			}
		}

		// 显示模板选择
		function showTemplates() {
			const templates = generatePropertyTemplates();
			const templateNames = Object.keys(templates).sort((a, b) => templates[b].count - templates[a].count);

			let templateHtml = '<div class="template-modal">';
			templateHtml += '<h4>选择常用属性模板</h4>';
			templateHtml += '<div class="template-list">';

			templateNames.forEach(name => {
				const template = templates[name];
				templateHtml += `
                    <div class="template-item" onclick="applyTemplate('${name}', '${template.type}')">
                        <span class="template-name">${template.label || name}</span>
                        <span class="template-count">(${template.count}次使用)</span>
                    </div>
                `;
			});

			templateHtml += '</div></div>';

			// 创建模态框
			const modal = document.createElement('div');
			modal.className = 'template-modal-overlay';
			modal.innerHTML = templateHtml;
			modal.onclick = function (e) {
				if (e.target === modal) {
					document.body.removeChild(modal);
				}
			};

			document.body.appendChild(modal);
		}

		// 应用模板
		function applyTemplate(propertyName, propertyType) {
			addProperty();

			const propertiesList = document.getElementById('propertiesList');
			const lastProperty = propertiesList.lastElementChild;

			const nameInput = lastProperty.querySelector('.property-name');
			const typeSelect = lastProperty.querySelector('.property-type');
			const valueInput = lastProperty.querySelector('.property-value');

			nameInput.value = propertyName;
			typeSelect.value = propertyType;

			updatePropertyType(typeSelect);

			// 关闭模态框
			const modal = document.querySelector('.template-modal-overlay');
			if (modal) {
				document.body.removeChild(modal);
			}
		}

		// 切换密码显示
		function togglePassword(button) {
			const valueElement = button.closest('.detail-value');
			const icon = button.querySelector('i');

			if (valueElement.classList.contains('show')) {
				valueElement.classList.remove('show');
				icon.className = 'fas fa-eye';
			} else {
				valueElement.classList.add('show');
				icon.className = 'fas fa-eye-slash';
			}
		}

		// 切换密码输入框显示
		function togglePasswordInput(button) {
			const input = button.parentElement.querySelector('input');
			const icon = button.querySelector('i');

			if (input.type === 'password') {
				input.type = 'text';
				icon.className = 'fas fa-eye-slash';
			} else {
				input.type = 'password';
				icon.className = 'fas fa-eye';
			}
		}

		// 生成随机密码
		function generatePassword(button) {
			const input = button.parentElement.querySelector('input');
			const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
			let password = '';
			for (let i = 0; i < 16; i++) {
				password += chars.charAt(Math.floor(Math.random() * chars.length));
			}
			input.value = password;
		}

		// 搜索功能
		function setupSearch() {
			const searchInput = document.getElementById('searchInput');
			searchInput.addEventListener('input', (e) => {
				const searchTerm = e.target.value.toLowerCase();
				const filteredPasswords = passwordsData.filter(password => {
					const data = password.data || {};
					return password.category.toLowerCase().includes(searchTerm) ||
						(data.title && data.title.toLowerCase().includes(searchTerm)) ||
						(data.username && data.username.toLowerCase().includes(searchTerm)) ||
						JSON.stringify(data).toLowerCase().includes(searchTerm);
				});
				renderPasswords(filteredPasswords);
			});
		}

		// 显示Toast消息
		function showToast(message, type = 'info') {
			const toast = document.createElement('div');
			toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                max-width: 300px;
                word-wrap: break-word;
            `;

			switch (type) {
				case 'success':
					toast.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
					break;
				case 'error':
					toast.style.background = 'linear-gradient(135deg, #dc3545, #e74c3c)';
					break;
				case 'warning':
					toast.style.background = 'linear-gradient(135deg, #ffc107, #fd7e14)';
					break;
				default:
					toast.style.background = 'linear-gradient(135deg, #17a2b8, #6f42c1)';
			}

			toast.textContent = message;
			document.body.appendChild(toast);

			setTimeout(() => {
				toast.style.transform = 'translateX(0)';
			}, 100);

			setTimeout(() => {
				toast.style.transform = 'translateX(100%)';
				setTimeout(() => {
					document.body.removeChild(toast);
				}, 300);
			}, 3000);
		}

		// 隐藏新密码表单
		function hideNewPasswordForm() {
			const newPasswordItem = document.querySelector('.new-password-item');
			if (newPasswordItem) {
				newPasswordItem.remove();
			}
		}

		// 添加新密码
		async function addNewPassword(event) {
			event.preventDefault();

			const form = event.target;
			const formData = new FormData(form);

			// 构建账户数据
			const accountData = {};
			const properties = {};

			for (const [key, value] of formData.entries()) {
				if (key.startsWith('property_')) {
					const parts = key.split('_');
					const propertyIndex = parts[1];
					const fieldType = parts[2];

					if (!properties[propertyIndex]) {
						properties[propertyIndex] = {};
					}
					properties[propertyIndex][fieldType] = value;
				}
			}

			// 将属性转换为账户数据
			Object.values(properties).forEach(property => {
				if (property.name && property.value !== undefined) {
					accountData[property.name] = property.value;
				}
			});

			const passwordData = {
				category: formData.get('category'),
				data: [accountData] // 包装为数组格式
			};

			try {
				const authToken = getAuthToken();
				const response = await fetch(`${API_BASE}/userdata/passwords`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'Authorization': `Bearer ${authToken}`
					},
					body: JSON.stringify(passwordData)
				});

				if (!response.ok) {
					throw new Error('添加失败');
				}

				const result = await response.json();

				// 添加到本地数据
				passwordsData.unshift(result.data);
				renderPasswords(passwordsData);

				// 隐藏表单
				hideNewPasswordForm();

				showToast('添加成功！', 'success');
			} catch (error) {
				console.error('添加密码失败:', error);
				showToast('添加失败: ' + error.message, 'error');
			}
		}

		// 智能属性推荐系统
		function getRecommendedProperties() {
			// 基于现有数据分析的推荐属性
			const recommendations = {
				// 高频属性（权重 5-10）
				high: [
					{ name: 'phone', type: 'phone', weight: 10, description: '手机号码' },
					{ name: '备注', type: 'textarea', weight: 9, description: '备注信息' },
					{ name: 'user', type: 'text', weight: 8, description: '用户名/用户' },
					{ name: 'loginEmail', type: 'email', weight: 7, description: '登录邮箱' },
					{ name: 'pullEmail', type: 'email', weight: 7, description: '推送邮箱' }
				],

				// 中频属性（权重 3-6）
				medium: [
					{ name: '卡号', type: 'text', weight: 6, description: '银行卡号' },
					{ name: '身份证号', type: 'text', weight: 5, description: '身份证号码' },
					{ name: '登录密码', type: 'password', weight: 5, description: '登录密码' },
					{ name: '交易密码', type: 'password', weight: 4, description: '交易密码' },
					{ name: '图案登录密码', type: 'text', weight: 4, description: '图案密码' },
					{ name: '账号', type: 'text', weight: 4, description: '账号信息' },
					{ name: '账号2', type: 'text', weight: 3, description: '备用账号' },
					{ name: 'QQ', type: 'text', weight: 3, description: 'QQ号码' },
					{ name: 'wx', type: 'text', weight: 3, description: '微信号' }
				],

				// 低频但有用的属性（权重 1-3）
				low: [
					{ name: '智慧职教pwd', type: 'password', weight: 2, description: '智慧职教密码' },
					{ name: 'NumberOne', type: 'text', weight: 1, description: '编号' },
					{ name: 'Phone', type: 'phone', weight: 1, description: '手机号（大写）' },
					{ name: 'one', type: 'password', weight: 1, description: '密码1' },
					{ name: 'two', type: 'password', weight: 1, description: '密码2' },
					{ name: 'three', type: 'password', weight: 1, description: '密码3' },
					{ name: 'four', type: 'password', weight: 1, description: '密码4' },
					{ name: 'five', type: 'password', weight: 1, description: '密码5' },
					{ name: 'six', type: 'password', weight: 1, description: '密码6' }
				]
			};

			return recommendations;
		}

		// 显示智能推荐模板
		function showTemplates() {
			const recommendations = getRecommendedProperties();
			const templateModal = document.createElement('div');
			templateModal.className = 'modal-overlay';
			templateModal.innerHTML = `
                <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3><i class="fas fa-lightbulb"></i> 智能属性推荐</h3>
                        <button class="close-btn" onclick="this.closest('.modal-overlay').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="template-sections">
                            <div class="template-section">
                                <h4><i class="fas fa-star"></i> 高频推荐 (${recommendations.high.length}个)</h4>
                                <div class="template-grid">
                                    ${recommendations.high.map(prop => `
                                        <div class="template-item" onclick="addRecommendedProperty('${prop.name}', '${prop.type}', '${prop.description}')">
                                            <div class="template-name">${prop.name}</div>
                                            <div class="template-type">${getTypeDisplayName(prop.type)}</div>
                                            <div class="template-desc">${prop.description}</div>
                                            <div class="template-weight">权重: ${prop.weight}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div class="template-section">
                                <h4><i class="fas fa-star-half-alt"></i> 中频推荐 (${recommendations.medium.length}个)</h4>
                                <div class="template-grid">
                                    ${recommendations.medium.map(prop => `
                                        <div class="template-item" onclick="addRecommendedProperty('${prop.name}', '${prop.type}', '${prop.description}')">
                                            <div class="template-name">${prop.name}</div>
                                            <div class="template-type">${getTypeDisplayName(prop.type)}</div>
                                            <div class="template-desc">${prop.description}</div>
                                            <div class="template-weight">权重: ${prop.weight}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div class="template-section">
                                <h4><i class="far fa-star"></i> 低频推荐 (${recommendations.low.length}个)</h4>
                                <div class="template-grid">
                                    ${recommendations.low.map(prop => `
                                        <div class="template-item" onclick="addRecommendedProperty('${prop.name}', '${prop.type}', '${prop.description}')">
                                            <div class="template-name">${prop.name}</div>
                                            <div class="template-type">${getTypeDisplayName(prop.type)}</div>
                                            <div class="template-desc">${prop.description}</div>
                                            <div class="template-weight">权重: ${prop.weight}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

			document.body.appendChild(templateModal);
		}

		// 获取类型显示名称
		function getTypeDisplayName(type) {
			const typeNames = {
				'text': '文本',
				'password': '密码',
				'email': '邮箱',
				'phone': '手机号',
				'select': '选择',
				'textarea': '多行文本'
			};
			return typeNames[type] || type;
		}

		// 添加推荐的属性
		function addRecommendedProperty(name, type, description) {
			const propertiesList = document.getElementById('propertiesList');
			const currentIndex = propertiesList.children.length;

			const propertyItem = document.createElement('div');
			propertyItem.className = 'property-item';
			propertyItem.setAttribute('data-property-index', currentIndex);

			propertyItem.innerHTML = `
                <div class="property-header">
                    <input type="text" name="property_${currentIndex}_name" value="${name}" placeholder="属性名" class="property-name">
                    <select name="property_${currentIndex}_type" class="property-type" onchange="updatePropertyType(this)">
                        <option value="text" ${type === 'text' ? 'selected' : ''}>文本</option>
                        <option value="select" ${type === 'select' ? 'selected' : ''}>选择</option>
                        <option value="password" ${type === 'password' ? 'selected' : ''}>密码</option>
                        <option value="email" ${type === 'email' ? 'selected' : ''}>邮箱</option>
                        <option value="phone" ${type === 'phone' ? 'selected' : ''}>手机号</option>
                        <option value="textarea" ${type === 'textarea' ? 'selected' : ''}>多行文本</option>
                    </select>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeProperty(${currentIndex})" title="删除属性">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="property-content">
                    ${getPropertyInput(type, currentIndex)}
                </div>
            `;

			propertiesList.appendChild(propertyItem);

			// 关闭模态框
			const modal = document.querySelector('.modal-overlay');
			if (modal) modal.remove();

			// 显示提示
			showToast(`已添加属性: ${name} (${description})`, 'success');
		}

		// 根据类型生成输入框
		function getPropertyInput(type, index) {
			switch (type) {
				case 'select':
					return `<select name="property_${index}_value" class="property-value">
                        <option value="">请选择</option>
                        <option value="active">active</option>
                        <option value="inactive">inactive</option>
                        <option value="pending">pending</option>
                    </select>`;
				case 'password':
					return `<input type="text" name="property_${index}_value" placeholder="属性值" class="property-value">
                        <button type="button" class="generate-btn" onclick="generatePassword(this)">
                            <i class="fas fa-magic"></i>
                        </button>`;
				case 'email':
					return `<input type="email" name="property_${index}_value" placeholder="属性值" class="property-value">`;
				case 'phone':
					return `<input type="tel" name="property_${index}_value" placeholder="属性值" class="property-value">`;
				case 'textarea':
					return `<textarea name="property_${index}_value" placeholder="属性值" class="property-value" rows="3"></textarea>`;
				default:
					return `<input type="text" name="property_${index}_value" placeholder="属性值" class="property-value">`;
			}
		}

		// 页面初始化
		async function init() {
			const isAuthenticated = await checkAuth();

			if (isAuthenticated) {
				await loadPasswords();
				setupSearch();
			} else {
				document.getElementById('passwordsContainer').innerHTML = `
                    <div class="error">
                        <i class="fas fa-exclamation-triangle"></i>
                        请先登录后再访问此页面
                        <br><br>
                        <a href="/Pages/login.html" style="color: #667eea; text-decoration: none;">
                            <i class="fas fa-sign-in-alt"></i> 前往登录
                        </a>
                    </div>
                `;
			}
		}

		// 延迟启动应用，给页面更多时间加载
		setTimeout(() => {
			init();
		}, 100);

		// 通用数据兼容系统
		class DataCompatibilitySystem {
			// 分析数据结构类型
			static analyzeDataStructure(data) {
				if (!data || typeof data !== 'object') {
					return { type: 'empty', accounts: [] };
				}

				if (Array.isArray(data)) {
					return { type: 'array', accounts: data };
				}

				// 对象格式：可能是嵌套对象或扁平对象
				const keys = Object.keys(data);
				if (keys.length === 0) {
					return { type: 'empty', accounts: [] };
				}

				// 检查是否为嵌套对象结构
				const firstKey = keys[0];
				const firstValue = data[firstKey];

				if (typeof firstValue === 'object' && firstValue !== null) {
					// 嵌套对象：{ "key1": { ... }, "key2": { ... } }
					return {
						type: 'nested_object',
						accounts: Object.keys(data).map(key => ({
							key: key,
							data: data[key]
						}))
					};
				} else {
					// 扁平对象：{ "prop1": "value1", "prop2": "value2" }
					return {
						type: 'flat_object',
						accounts: [{ key: 'default', data: data }]
					};
				}
			}

			// 标准化数据格式
			static normalizeData(data) {
				const structure = this.analyzeDataStructure(data);

				switch (structure.type) {
					case 'array':
						return structure.accounts.map((account, index) => ({
							id: index,
							key: account.username || account.user || `账户${index + 1}`,
							data: account
						}));

					case 'nested_object':
						return structure.accounts.map(account => ({
							id: account.key,
							key: account.key,
							data: account.data
						}));

					case 'flat_object':
						return structure.accounts.map(account => ({
							id: 'default',
							key: '默认账户',
							data: account.data
						}));

					default:
						return [];
				}
			}

			// 获取账户显示名称
			static getAccountDisplayName(account) {
				const data = account.data;

				// 优先级：username > user > key > 默认名称
				return data.username ||
					data.user ||
					account.key ||
					'未设置用户名';
			}

			// 获取账户属性列表
			static getAccountProperties(account) {
				const data = account.data;
				const properties = [];

				Object.keys(data).forEach(key => {
					const value = data[key];
					// 包含所有属性，包括null、undefined和空字符串
					properties.push({
						key: key,
						value: value,
						type: this.guessPropertyType(key, value)
					});
				});

				return properties;
			}

			// 猜测属性类型
			static guessPropertyType(key, value) {
				const keyLower = key.toLowerCase();
				const valueStr = String(value).toLowerCase();

				// 基于属性名猜测
				if (keyLower.includes('password') || keyLower.includes('pwd')) {
					return 'password';
				}
				if (keyLower.includes('email') || valueStr.includes('@')) {
					return 'email';
				}
				if (keyLower.includes('phone') || /^\d{11}$/.test(value)) {
					return 'phone';
				}
				if (keyLower.includes('备注') || keyLower.includes('description') || keyLower.includes('desc')) {
					return 'textarea';
				}
				if (keyLower.includes('status') || ['active', 'inactive', 'pending'].includes(valueStr)) {
					return 'select';
				}

				// 基于值类型猜测
				if (typeof value === 'string' && value.length > 100) {
					return 'textarea';
				}

				return 'text';
			}

			// 合并数据（用于保存）
			static mergeData(originalData, updatedAccounts) {
				const structure = this.analyzeDataStructure(originalData);

				switch (structure.type) {
					case 'array':
						return updatedAccounts.map(account => account.data);

					case 'nested_object':
						const result = {};
						updatedAccounts.forEach(account => {
							result[account.key] = account.data;
						});
						return result;

					case 'flat_object':
						return updatedAccounts[0]?.data || {};

					default:
						return {};
				}
			}
		}
	</script>
</body>

</html>