<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OneLove 管理中心</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #4a5568;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header .subtitle {
            color: #718096;
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .stat-card .icon {
            font-size: 2.5em;
            margin-bottom: 15px;
            color: #667eea;
        }

        .stat-card .number {
            font-size: 2em;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .stat-card .label {
            color: #718096;
            font-size: 14px;
        }

        .modules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .module-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .module-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            border-color: #667eea;
        }

        .module-card .icon {
            font-size: 3em;
            margin-bottom: 20px;
            color: #667eea;
        }

        .module-card h3 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .module-card .description {
            color: #718096;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .module-card .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: transform 0.2s ease;
        }

        .module-card .btn:hover {
            transform: scale(1.05);
        }

        .user-info {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .user-info h3 {
            color: #2d3748;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .user-detail {
            padding: 10px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
        }

        .user-detail .label {
            font-size: 12px;
            color: #718096;
            margin-bottom: 5px;
        }

        .user-detail .value {
            font-weight: 500;
            color: #2d3748;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .modules-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- 头部 -->
        <div class="header">
            <h1>
                <i class="fas fa-tachometer-alt"></i>
                OneLove 管理中心
            </h1>
            <div class="subtitle" id="subtitle">管理您的密码、手机号码和其他重要数据</div>
        </div>

        <!-- 数据统计 -->
        <div class="stats-grid" id="statsGrid">
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i>
                加载统计数据...
            </div>
        </div>

        <!-- 功能模块 -->
        <div class="modules-grid">
            <div class="module-card" onclick="openModule('passwords')">
                <div class="icon">
                    <i class="fas fa-key"></i>
                </div>
                <h3>密码管理</h3>
                <div class="description">
                    管理您的所有密码信息，包括网站登录、应用密码等，支持分类管理和安全存储。
                </div>
                <button class="btn">进入管理</button>
            </div>

            <div class="module-card" onclick="openModule('phones')">
                <div class="icon">
                    <i class="fas fa-mobile-alt"></i>
                </div>
                <h3>手机管理</h3>
                <div class="description">
                    管理手机号码信息，包括套餐详情、绑定应用、备注信息等。
                </div>
                <button class="btn">进入管理</button>
            </div>

            <div class="module-card admin-only" onclick="openModule('users')" style="display: none;">
                <div class="icon">
                    <i class="fas fa-users"></i>
                </div>
                <h3>用户管理</h3>
                <div class="description">
                    管理用户账户信息，查看用户详情，修改账户设置等。
                </div>
                <button class="btn">进入管理</button>
            </div>

            <div class="module-card admin-only" onclick="openModule('data-management')" style="display: none;">
                <div class="icon">
                    <i class="fas fa-database"></i>
                </div>
                <h3>数据管理</h3>
                <div class="description">
                    数据导入导出、备份恢复、批量操作等数据管理功能。
                </div>
                <button class="btn">进入管理</button>
            </div>

            <div class="module-card admin-only" onclick="openModule('security-audit')" style="display: none;">
                <div class="icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <h3>安全审计</h3>
                <div class="description">
                    访问日志记录、安全事件监控、数据加密保护等安全功能。
                </div>
                <button class="btn">进入审计</button>
            </div>

            <div class="module-card admin-only" onclick="openModule('settings')" style="display: none;">
                <div class="icon">
                    <i class="fas fa-cog"></i>
                </div>
                <h3>系统设置</h3>
                <div class="description">
                    系统配置、安全设置、数据备份等高级功能。
                </div>
                <button class="btn">进入设置</button>
            </div>
        </div>

        <!-- 用户信息 -->
        <div class="user-info" id="userInfo">
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i>
                加载用户信息...
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin + '/api';

        // 获取认证令牌的函数
        function getAuthToken() {
            return sessionStorage.getItem('token');
        }

        // 检查登录状态
        async function checkAuth() {
            const authToken = getAuthToken();

            if (!authToken) {
                return false;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    sessionStorage.removeItem('token');
                    return false;
                }

                return true;
            } catch (error) {
                console.error('认证检查失败:', error);
                return false;
            }
        }

        // 加载统计数据
        async function loadStats() {
            try {
                const authToken = getAuthToken();
                const response = await fetch(`${API_BASE}/userdata/stats`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('获取统计数据失败');
                }

                const data = await response.json();
                displayStats(data.data);
            } catch (error) {
                console.error('加载统计数据失败:', error);
                document.getElementById('statsGrid').innerHTML = `
                    <div class="error">
                        <i class="fas fa-exclamation-triangle"></i>
                        加载统计数据失败: ${error.message}
                    </div>
                `;
            }
        }

        // 显示统计数据
        function displayStats(stats) {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="icon">
                        <i class="fas fa-database"></i>
                    </div>
                    <div class="number">${stats.total}</div>
                    <div class="label">总数据量</div>
                </div>
                <div class="stat-card">
                    <div class="icon">
                        <i class="fas fa-key"></i>
                    </div>
                    <div class="number">${stats.passwords}</div>
                    <div class="label">密码数据</div>
                </div>
                <div class="stat-card">
                    <div class="icon">
                        <i class="fas fa-mobile-alt"></i>
                    </div>
                    <div class="number">${stats.phones}</div>
                    <div class="label">手机数据</div>
                </div>
                <div class="stat-card">
                    <div class="icon">
                        <i class="fas fa-sticky-note"></i>
                    </div>
                    <div class="number">${stats.notes}</div>
                    <div class="label">笔记数据</div>
                </div>
            `;
        }

        // 加载用户信息
        async function loadUserInfo() {
            try {
                const authToken = getAuthToken();
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('获取用户信息失败');
                }

                const data = await response.json();
                const user = data.data.user;

                // 根据用户角色显示不同的功能模块和更新页面信息
                const adminCards = document.querySelectorAll('.admin-only');
                const subtitle = document.getElementById('subtitle');

                if (user.role === 'admin') {
                    // 管理员：显示所有功能
                    adminCards.forEach(card => {
                        card.style.display = 'block';
                    });
                    subtitle.textContent = '管理员控制面板 - 管理所有用户数据和系统功能';
                } else {
                    // 普通用户：只显示基本功能
                    adminCards.forEach(card => {
                        card.style.display = 'none';
                    });
                    subtitle.textContent = '管理您的密码、手机号码和其他重要数据';
                }

                displayUserInfo(user);
            } catch (error) {
                console.error('加载用户信息失败:', error);
                document.getElementById('userInfo').innerHTML = `
                    <div class="error">
                        <i class="fas fa-exclamation-triangle"></i>
                        加载用户信息失败: ${error.message}
                    </div>
                `;
            }
        }

        // 显示用户信息
        function displayUserInfo(user) {
            const userInfo = document.getElementById('userInfo');

            if (!user) {
                userInfo.innerHTML = `
                    <div class="error">
                        <i class="fas fa-exclamation-triangle"></i>
                        用户信息为空
                    </div>
                `;
                return;
            }

            userInfo.innerHTML = `
                <h3>
                    <i class="fas fa-user"></i>
                    当前用户信息
                </h3>
                <div class="user-details">
                    <div class="user-detail">
                        <div class="label">用户名</div>
                        <div class="value">${user.username || '未知用户'}</div>
                    </div>
                    <div class="user-detail">
                        <div class="label">邮箱</div>
                        <div class="value">${user.email || '未设置邮箱'}</div>
                    </div>
                    <div class="user-detail">
                        <div class="label">角色</div>
                        <div class="value">${user.role || '普通用户'}</div>
                    </div>
                    <div class="user-detail">
                        <div class="label">用户ID</div>
                        <div class="value">${user._id || user.id || '未知'}</div>
                    </div>
                </div>
            `;
        }

        // 打开功能模块
        function openModule(module) {
            switch (module) {
                case 'passwords':
                    window.location.href = '/Pages/admin/passwords.html';
                    break;
                case 'phones':
                    window.location.href = '/Pages/admin/phones.html';
                    break;
                case 'users':
                    window.location.href = '/Pages/admin/users.html';
                    break;
                case 'data-management':
                    window.location.href = '/Pages/admin/data-management.html';
                    break;
                case 'security-audit':
                    window.location.href = '/Pages/admin/security-audit.html';
                    break;
                case 'settings':
                    window.location.href = '/Pages/admin/settings.html';
                    break;

                default:
                    alert('功能开发中...');
            }
        }

        // 页面初始化
        async function init() {
            const isAuthenticated = await checkAuth();

            if (isAuthenticated) {
                await loadStats();
                await loadUserInfo();
            } else {
                // 显示错误信息而不是自动跳转
                document.getElementById('statsGrid').innerHTML = `
                    <div class="error">
                        <i class="fas fa-exclamation-triangle"></i>
                        请先登录后再访问此页面
                        <br><br>
                        <a href="/Pages/login.html" style="color: #667eea; text-decoration: none;">
                            <i class="fas fa-sign-in-alt"></i> 前往登录
                        </a>
                    </div>
                `;
                document.getElementById('userInfo').innerHTML = `
                    <div class="error">
                        <i class="fas fa-exclamation-triangle"></i>
                        需要登录才能查看用户信息
                    </div>
                `;
            }
        }

        // 延迟启动应用，给页面更多时间加载
        setTimeout(() => {
            init();
        }, 100);
    </script>
</body>

</html>