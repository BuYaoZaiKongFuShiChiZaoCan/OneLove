<!DOCTYPE html>
<html lang="zh-CN">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>登录 - OneLove</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
	<style>
		body {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
			display: flex;
			align-items: center;
			justify-content: center;
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
		}

		.login-container {
			background: white;
			border-radius: 20px;
			box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
			overflow: hidden;
			width: 100%;
			max-width: 400px;
			margin: 20px;
		}

		.login-header {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			padding: 30px;
			text-align: center;
		}

		.login-header h2 {
			margin: 0;
			font-size: 2rem;
			font-weight: 300;
		}

		.login-header p {
			margin: 10px 0 0 0;
			opacity: 0.9;
		}

		.login-body {
			padding: 40px 30px;
		}

		.form-floating {
			margin-bottom: 20px;
		}

		.form-control {
			border-radius: 10px;
			border: 2px solid #e9ecef;
			padding: 12px 15px;
			transition: all 0.3s ease;
		}

		.form-control:focus {
			border-color: #667eea;
			box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
		}

		.btn-login {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			border: none;
			border-radius: 10px;
			padding: 12px;
			font-size: 1.1rem;
			font-weight: 500;
			width: 100%;
			transition: all 0.3s ease;
		}

		.btn-login:hover {
			transform: translateY(-2px);
			box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
		}

		.btn-login:disabled {
			opacity: 0.7;
			transform: none;
		}

		.register-link {
			text-align: center;
			margin-top: 20px;
			padding-top: 20px;
			border-top: 1px solid #e9ecef;
		}

		.register-link a {
			color: #667eea;
			text-decoration: none;
			font-weight: 500;
		}

		.register-link a:hover {
			text-decoration: underline;
		}

		.alert {
			border-radius: 10px;
			border: none;
			margin-bottom: 20px;
		}

		.loading {
			display: none;
		}

		.spinner-border-sm {
			width: 1rem;
			height: 1rem;
		}

		.remember-me {
			display: flex;
			align-items: center;
			justify-content: space-between;
			margin-bottom: 20px;
		}

		.form-check {
			margin: 0;
		}

		.forgot-password {
			color: #667eea;
			text-decoration: none;
			font-size: 0.9rem;
		}

		.forgot-password:hover {
			text-decoration: underline;
		}
	</style>
</head>

<body>
	<div class="login-container">
		<div class="login-header">
			<h2><i class="fas fa-heart"></i> OneLove</h2>
			<p>欢迎回来</p>
		</div>

		<div class="login-body">
			<!-- 成功消息 -->
			<div class="alert alert-success" id="successAlert" style="display: none;">
				<i class="fas fa-check-circle"></i> <span id="successMessage"></span>
			</div>

			<!-- 错误消息 -->
			<div class="alert alert-danger" id="errorAlert" style="display: none;">
				<i class="fas fa-exclamation-circle"></i> <span id="errorMessage"></span>
			</div>

			<form id="loginForm">
				<div class="form-floating">
					<input type="text" class="form-control" id="username" placeholder="用户名或邮箱" required>
					<label for="username">用户名或邮箱</label>
				</div>

				<div class="form-floating">
					<input type="password" class="form-control" id="password" placeholder="密码" required>
					<label for="password">密码</label>
				</div>

				<div class="remember-me">
					<div class="form-check">
						<input class="form-check-input" type="checkbox" id="rememberMe">
						<label class="form-check-label" for="rememberMe">
							记住我
						</label>
					</div>
					<a href="JavaScript:;" class="forgot-password" onclick="showForgotPassword()">忘记密码？</a>
				</div>

				<button type="submit" class="btn btn-primary btn-login" id="loginBtn">
					<span class="btn-text">登录</span>
					<span class="loading">
						<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
						登录中...
					</span>
				</button>
			</form>

			<div class="register-link">
				<p>还没有账户？ <a href="register.html">立即注册</a></p>
			</div>
		</div>
	</div>


	<script>
		// 配置API基础URL
		window.OneLoveConfig = { apiBaseUrl: '/api' };
		
		// 使用配置文件中的API基础URL
		const API_BASE = window.OneLoveConfig?.apiBaseUrl || window.location.origin;
		// 确保API_BASE不以/api结尾，避免重复
		const cleanApiBase = API_BASE.endsWith('/api') ? API_BASE.slice(0, -4) : API_BASE;

		// 显示消息函数
		function showMessage(type, message) {
			const successAlert = document.getElementById('successAlert');
			const errorAlert = document.getElementById('errorAlert');
			const successMessage = document.getElementById('successMessage');
			const errorMessage = document.getElementById('errorMessage');

			// 隐藏所有消息
			successAlert.style.display = 'none';
			errorAlert.style.display = 'none';

			if (type === 'success') {
				successMessage.textContent = message;
				successAlert.style.display = 'block';
			} else {
				errorMessage.textContent = message;
				errorAlert.style.display = 'block';
			}
		}

		// 设置加载状态
		function setLoading(loading) {
			const loginBtn = document.getElementById('loginBtn');
			const btnText = loginBtn.querySelector('.btn-text');
			const loadingSpan = loginBtn.querySelector('.loading');

			if (loading) {
				btnText.style.display = 'none';
				loadingSpan.style.display = 'inline-block';
				loginBtn.disabled = true;
			} else {
				btnText.style.display = 'inline-block';
				loadingSpan.style.display = 'none';
				loginBtn.disabled = false;
			}
		}

		// 登录表单提交
		document.getElementById('loginForm').addEventListener('submit', async (e) => {
			e.preventDefault();

			const username = document.getElementById('username').value.trim();
			const password = document.getElementById('password').value;
			const rememberMe = document.getElementById('rememberMe').checked;

			// 验证输入
			if (!username || !password) {
				showMessage('error', '请填写用户名和密码');
				return;
			}

			setLoading(true);

			try {
				console.log('正在发送登录请求...');
				const response = await fetch(`${cleanApiBase}/api/auth/login`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({
						username,
						password
					})
				});

				console.log('收到响应:', response.status);
				const data = await response.json();
				console.log('响应数据:', data);

				if (data.success) {
					showMessage('success', '登录成功！正在跳转...');

					// 保存令牌
					const token = data.data.token;
					if (rememberMe) {
						localStorage.setItem('token', token);
						localStorage.setItem('user', JSON.stringify(data.data.user));
					} else {
						sessionStorage.setItem('token', token);
						sessionStorage.setItem('user', JSON.stringify(data.data.user));
					}

					// 清空表单
					document.getElementById('loginForm').reset();

					// 跳转到主页
					console.log('准备跳转到主页...');
					setTimeout(() => {
						console.log('执行跳转...');
						
						// 获取来源页面URL（优先使用保存的来源页面）
						const savedReferrer = sessionStorage.getItem('loginReferrer');
						const referrer = savedReferrer || document.referrer;
						const currentOrigin = window.location.origin;
						
						// 检查是否有有效的来源页面（同域名且不是登录页本身）
						if (referrer && 
							referrer.startsWith(currentOrigin) && 
							!referrer.includes('/login.html') && 
							!referrer.includes('/Pages/login.html')) {
							
							// 清除保存的来源页面信息
							sessionStorage.removeItem('loginReferrer');
							
							// 方案1：直接跳转到来源页面并刷新
							window.location.replace(referrer);
							
							// 方案2：如果上面的方案不行，可以尝试这个备选方案
							// setTimeout(() => {
							// 	window.location.href = referrer;
							// }, 100);
						} else {
							// 没有有效来源页面，跳转到主页
							window.location.href = window.location.origin;
						}
					}, 1500);

				} else {
					showMessage('error', data.message || '登录失败');
				}

			} catch (error) {
				console.error('登录错误:', error);
				showMessage('error', `网络错误: ${error.message}`);
			} finally {
				setLoading(false);
			}
		});

		// 忘记密码功能
		function showForgotPassword() {
			const email = prompt('请输入您的邮箱地址，我们将发送重置密码链接：');
			if (email && email.trim()) {
				resetPassword(email.trim());
			}
		}

		// 生成带返回URL的登录链接（供其他页面使用）
		function getLoginUrl(returnUrl = null) {
			const loginUrl = window.location.href;
			if (returnUrl) {
				const url = new URL(loginUrl);
				url.searchParams.set('returnUrl', returnUrl);
				return url.toString();
			}
			return loginUrl;
		}
		
		// 重置密码
		async function resetPassword(email) {
			try {
				const response = await fetch(`${API_BASE}/api/auth/forgot-password`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({ email })
				});

				const data = await response.json();

				if (data.success) {
					showMessage('success', '重置密码链接已发送到您的邮箱，请查收！');
				} else {
					showMessage('error', data.message || '发送重置链接失败');
				}
			} catch (error) {
				console.error('重置密码错误:', error);
				showMessage('error', '网络错误，请稍后重试');
			}
		}

		// 页面加载时记录来源页面（如果不是直接访问登录页）
		window.addEventListener('load', () => {
			// 检查URL参数中是否有来源页面信息
			const urlParams = new URLSearchParams(window.location.search);
			const returnUrl = urlParams.get('returnUrl');
			
			// 记录来源页面信息（优先使用URL参数，其次是referrer）
			const referrer = returnUrl || document.referrer;
			const currentOrigin = window.location.origin;
			
			// 如果有有效的来源页面且不是登录页本身，保存到 sessionStorage
			if (referrer && 
				referrer.startsWith(currentOrigin) && 
				!referrer.includes('/login.html') && 
				!referrer.includes('/Pages/login.html')) {
				sessionStorage.setItem('loginReferrer', referrer);
			}
			
			// 检查是否已登录
			const token = localStorage.getItem('token') || sessionStorage.getItem('token');
			if (token) {
				// 验证令牌有效性
				fetch(`${API_BASE}/api/auth/me`, {
					headers: {
						'Authorization': `Bearer ${token}`
					}
				})
					.then(response => response.json())
					.then(data => {
						if (data.success) {
							// 已登录，跳转到主页
							window.location.href = '../index.html';
						}
					})
					.catch(error => {
						console.log('令牌验证失败，需要重新登录');
					});
			}
		});
	</script>
</body>

</html>